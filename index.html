
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Lerntool E1 / E2a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
          colors: {
            // Deep Space Theme
            bg: { light: '#F8FAFC', dark: '#0F172A' },
            surface: { light: '#FFFFFF', dark: '#1E293B' },
            border: { light: '#E2E8F0', dark: '#334155' },
            primary: { DEFAULT: '#6366F1', dark: '#4338CA', light: '#EEF2FF' },
            accent:  { DEFAULT: '#F472B6', dark: '#DB2777' }, // Pink for streaks
            success: { DEFAULT: '#22C55E', dark: '#15803D', light: '#DCFCE7' },
            danger:  { DEFAULT: '#EF4444', dark: '#B91C1C', light: '#FEE2E2' },
            warning: { DEFAULT: '#F59E0B', dark: '#D97706', light: '#FEF3C7' },
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out',
            'slide-up': 'slideUp 0.5s cubic-bezier(0.19, 1, 0.22, 1)',
            'scale-in': 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
            'pulse-slow': 'pulse 3s infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
          }
        }
      }
    };
  </script>
  <style>
    /* Custom Scrollbar for sleek look */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    
    /* Tactile Button logic */
    .btn-tactile {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .btn-tactile:active {
      transform: scale(0.96);
    }
    
    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .dark .glass {
      background: rgba(30, 41, 59, 0.7);
    }

    .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="module">
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, doc, writeBatch, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLH5c69JKeFWcJyBpzRUfv720KjnnRIU8",
      authDomain: "e1-und-e2a-lerntool.firebaseapp.com",
      projectId: "e1-und-e2a-lerntool",
      storageBucket: "e1-und-e2a-lerntool.firebasestorage.app",
      messagingSenderId: "28649721297",
      appId: "1:28649721297:web:432abbe98e34dd50fc24f0"
    };

    function ensureApp(){ return getApps().length ? getApp() : initializeApp(firebaseConfig); }
    const app = ensureApp();
    const db = getFirestore(app);
    const auth = getAuth(app);
    let authPromise = new Promise((resolve) => {
      const unsub = onAuthStateChanged(auth, (user) => {
        if(user) { resolve(user); unsub(); }
        else { signInAnonymously(auth).catch(()=>{}); }
      });
    });
    
    window.FIREBASE_BRIDGE = {
      ensureApp, getFirestore, collection, doc, writeBatch, onSnapshot, setDoc,
      ensureAuthUser: () => authPromise,
      auth
    };
    window.__FIREBASE_BRIDGE_READY__ = true;
    window.dispatchEvent(new Event('firebase-bridge-ready'));
  </script>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-slate-800 dark:text-slate-100 select-none font-sans antialiased selection:bg-primary selection:text-white">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    /* ================= ICONS ================= */
    const Icons = {
      Check: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12" /></svg>,
      X: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>,
      Home: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
      Book: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
      Settings: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
      User: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
      Flame: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3a9 9 0 0 0 2.5 2.8z"></path></svg>,
      CloudCheck: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><polyline points="8 15 11 18 16 11"></polyline></svg>,
      Award: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>,
      ArrowRight: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
      Upload: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
      Trash: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
      Edit: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
      Moon: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
      Sun: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
      Clock: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
      BarChart: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>,
      Target: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>,
      Calendar: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
      TrendingUp: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
      Clipboard: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>,
      Minus: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    };

    /* ================= UTILS & LOGIC ================= */
    const clone = (o) => JSON.parse(JSON.stringify(o));
    const generateId = (p="id") => `${p}-${Math.random().toString(36).slice(2,8)}`;
    const hashPassword = (s) => `h${s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a|0},0)}`;
    
    function xmur3(str){ let h = 1779033703 ^ str.length; for(let i=0;i<str.length;i++){ h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h << 13 | h >>> 19; } return function(){ h = Math.imul(h ^ h >>> 16, 2246822507); h = Math.imul(h ^ h >>> 13, 3266489909); return (h ^ h >>> 16) >>> 0; }; }
    function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
    function weightedOrder(items, tierResolver, seedStr){ const seed = xmur3(seedStr)(); const rng = mulberry32(seed); return [...items].map(x => ({ x, k: (rng() || Number.EPSILON) ** (1 / ({1:5,2:3,3:2,4:1.2,5:1}[tierResolver(x.id)]||1)) })).sort((a,b) => b.k - a.k).map(o => o.x); }

    // Shared scoring: +1 correct eval, -1 incorrect eval, 0 skipped, floor 0 per question
    function scoreQuestion(q, marks) {
       let points = 0;
       for(let ci = 0; ci < (q.choices || []).length; ci++) {
          const isCorrectChoice = (q.correct || []).includes(ci);
          const userMark = (marks || {})[ci] || null;
          if(userMark === null) { /* 0 */ }
          else if(userMark === 'true') { points += isCorrectChoice ? 1 : -1; }
          else if(userMark === 'false') { points += isCorrectChoice ? -1 : 1; }
       }
       return Math.max(0, points);
    }

    /* ================= HOOKS ================= */
    function useUserLocalStorage(userId, key, initial){
      const storageKey = userId ? `${userId}:${key}` : null;
      const [state, setState] = useState(() => { try { return storageKey ? (JSON.parse(localStorage.getItem(storageKey)) || initial) : initial; } catch { return initial; } });
      const [status, setStatus] = useState("local"); 

      useEffect(() => { if(!userId) return; localStorage.setItem(storageKey, JSON.stringify(state)); }, [state, storageKey, userId]);
      useEffect(() => {
         if(!userId || !window.FIREBASE_BRIDGE) return;
         let unsub = () => {}; const { onSnapshot, doc, getFirestore, ensureApp, setDoc } = window.FIREBASE_BRIDGE; const db = getFirestore(ensureApp());
         const sync = async () => { try { setStatus("syncing"); unsub = onSnapshot(doc(db, "userProgress", userId), (snap) => { if(snap.exists()) { const data = snap.data(); if(data[key]) { setState(prev => JSON.stringify(prev) !== JSON.stringify(data[key]) ? data[key] : prev); setStatus("synced"); } } else { setDoc(doc(db, "userProgress", userId), { [key]: state }, { merge: true }); setStatus("synced"); } }, (err) => { setStatus("error"); }); } catch(e) { setStatus("error"); } };
         sync(); return () => unsub();
      }, [userId, key]);
      useEffect(() => {
         if(status === 'error' || !userId || !window.FIREBASE_BRIDGE) return;
         const timeout = setTimeout(() => { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; setDoc(doc(getFirestore(ensureApp()), "userProgress", userId), { [key]: state }, { merge: true }).then(() => setStatus("synced")).catch(() => setStatus("error")); }, 1000);
         return () => clearTimeout(timeout);
      }, [state, userId, key]);
      return [state, setState, status];
    }

    function useUsers() {
       const [users, setUsers] = useState(() => { try { return JSON.parse(localStorage.getItem("users") || "[]").filter(Boolean); } catch { return []; } });
       useEffect(() => { localStorage.setItem("users", JSON.stringify(users)); }, [users]);
       useEffect(() => {
          if(!window.FIREBASE_BRIDGE) return; const { onSnapshot, collection, getFirestore, ensureApp } = window.FIREBASE_BRIDGE;
          const unsub = onSnapshot(collection(getFirestore(ensureApp()), "users"), (snap) => { const remotes = snap.docs.map(d => d.data()); setUsers(prev => { const map = new Map(prev.map(u => [u.id, u])); remotes.forEach(u => map.set(u.id, u)); return Array.from(map.values()); }); }, (err) => {});
          return () => unsub();
       }, []);
       const login = (name, pwd) => { const hash = hashPassword(pwd); const u = users.find(u => u.username.toLowerCase() === name.toLowerCase() && u.passwordHash === hash); if(u) return { success: true, user: u }; return { success: false, error: "Ungültige Zugangsdaten" }; };
       const register = (name, pwd, code) => { if(users.some(u => u.username.toLowerCase() === name.toLowerCase())) return { success: false, error: "Nutzername vergeben" }; const role = (code === "POLIZEI-ADMIN") ? "admin" : "user"; const newUser = { id: generateId("u"), username: name, passwordHash: hashPassword(pwd), role }; setUsers(prev => [...prev, newUser]); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; setDoc(doc(getFirestore(ensureApp()), "users", newUser.id), newUser); } return { success: true, user: newUser }; };
       const updatePassword = (uid, newPwd) => { const hash = hashPassword(newPwd); setUsers(prev => prev.map(u => u.id === uid ? { ...u, passwordHash: hash } : u)); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; setDoc(doc(getFirestore(ensureApp()), "users", uid), { passwordHash: hash }, { merge: true }); } };
       return { users, login, register, updatePassword };
    }

    function useQuestions() {
       const [questions, setQuestions] = useState([]);
       const [status, setStatus] = useState("loading");
       useEffect(() => {
          const defaults = [ { id: "q1", question: "§ 43 BDG: Wie hat ein Beamter seine dienstlichen Aufgaben zu erfüllen?", choices: ["Unter Beachtung der Rechtsordnung", "Treu und gewissenhaft", "Nach eigenem Ermessen", "Nur auf Weisung", "Schnellstmöglich"], correct: [0, 1], explain: "Rechtstreue und Gewissenhaftigkeit sind Kernpflichten.", law_ref: "BDG § 43", tags: ["BDG"], difficulty: 1 }, { id: "q2", question: "Was ist bei einer Dienstzuteilung (§ 39 BDG) über 90 Tage erforderlich?", choices: ["Zustimmung des Beamten", "Schriftliche Weisung", "Keine Zustimmung nötig", "Personalvertretung muss zustimmen", "Darf nicht erfolgen"], correct: [0], explain: "Über 90 Tage ist die Zustimmung erforderlich, außer bei Ausbildung.", law_ref: "BDG § 39", tags: ["BDG"], difficulty: 2 }, ];
          if(!window.FIREBASE_BRIDGE) { setQuestions(defaults); return; }
          const { onSnapshot, collection, getFirestore, ensureApp } = window.FIREBASE_BRIDGE;
          const unsub = onSnapshot(collection(getFirestore(ensureApp()), "questions"), (snap) => { const list = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(q => !q.__deleted); if(list.length === 0) setQuestions(defaults); else setQuestions(list); setStatus("ready"); }, (err) => { setQuestions(defaults); setStatus("error"); });
          return () => unsub();
       }, []);
       const save = async (q) => { setQuestions(prev => { const idx = prev.findIndex(item => item.id === q.id); if(idx >= 0) { const n = [...prev]; n[idx] = q; return n; } return [...prev, q]; }); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; await setDoc(doc(getFirestore(ensureApp()), "questions", q.id), q); } };
       const remove = async (id) => { setQuestions(prev => prev.filter(q => q.id !== id)); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; await setDoc(doc(getFirestore(ensureApp()), "questions", id), { __deleted: true }, { merge: true }); } };
       return { questions, status, save, remove };
    }

    /* ================= DAILY STATS HELPER ================= */
    const todayKey = () => new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"

    function useDailyStreak(userId) {
       const [streakData, setStreakData, streakStatus] = useUserLocalStorage(userId, "streakData", { activeDays: [], currentStreak: 0, longestStreak: 0 });

       const recordActivity = useCallback(() => {
          const today = todayKey();
          setStreakData(prev => {
             const days = prev.activeDays || [];
             if(days.includes(today)) return prev; // already recorded
             const newDays = [...days, today].sort();

             // Calculate streak from most recent days backwards
             let streak = 1;
             const d = new Date(today);
             for(let i = 1; i < 1000; i++) {
                d.setDate(d.getDate() - 1);
                const prevDay = d.toISOString().slice(0, 10);
                if(newDays.includes(prevDay)) streak++;
                else break;
             }
             return { activeDays: newDays.slice(-90), currentStreak: streak, longestStreak: Math.max(prev.longestStreak || 0, streak) };
          });
       }, [setStreakData]);

       // Calculate current streak on load (in case user missed days)
       const currentStreak = useMemo(() => {
          const days = streakData.activeDays || [];
          if(days.length === 0) return 0;
          const today = todayKey();
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().slice(0, 10);

          // Streak counts if today or yesterday has activity
          const lastDay = days[days.length - 1];
          if(lastDay !== today && lastDay !== yesterdayStr) return 0;

          let streak = 0;
          const d = new Date(lastDay);
          for(let i = 0; i < 1000; i++) {
             const key = d.toISOString().slice(0, 10);
             if(days.includes(key)) streak++;
             else break;
             d.setDate(d.getDate() - 1);
          }
          return streak;
       }, [streakData.activeDays]);

       return { streakData, currentStreak, longestStreak: streakData.longestStreak || 0, recordActivity, activeDays: streakData.activeDays || [] };
    }

    function useLearningHistory(userId) {
       const [history, setHistory, hStatus] = useUserLocalStorage(userId, "learningHistory", []);

       const recordSession = useCallback((questionsAnswered, totalPoints, totalMaxPoints) => {
          const today = todayKey();
          setHistory(prev => {
             const arr = [...(prev || [])];
             const todayEntry = arr.find(e => e.date === today);
             if(todayEntry) {
                todayEntry.questionsAnswered += questionsAnswered;
                todayEntry.totalPoints = (todayEntry.totalPoints || 0) + totalPoints;
                todayEntry.totalMaxPoints = (todayEntry.totalMaxPoints || 0) + totalMaxPoints;
                todayEntry.sessions += 1;
             } else {
                arr.push({ date: today, questionsAnswered, totalPoints, totalMaxPoints, sessions: 1 });
             }
             return arr.slice(-90); // Keep 90 days
          });
       }, [setHistory]);

       return { history: history || [], recordSession };
    }

    /* ================= UI COMPONENTS ================= */
    const Button = ({ children, onClick, variant='primary', size='md', fullWidth=false, className='', disabled=false }) => {
       const base = "font-bold rounded-2xl btn-tactile disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2 tracking-wide";
       const variants = {
          primary: "bg-primary dark:bg-primary-dark text-white shadow-lg shadow-primary/20 hover:brightness-110",
          success: "bg-success dark:bg-success-dark text-white shadow-lg shadow-success/20",
          danger: "bg-danger dark:bg-danger-dark text-white shadow-lg shadow-danger/20",
          ghost: "bg-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800",
          outline: "border-2 border-border-light dark:border-border-dark text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50"
       };
       const sizes = { sm: "px-3 py-1 text-xs", md: "px-5 py-3 text-sm", lg: "px-6 py-4 text-base" };
       return (
          <button className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth?'w-full':''} ${className}`} onClick={onClick} disabled={disabled}>
             {children}
          </button>
       );
    };

    const SegmentedProgress = ({ current, total }) => (
      <div className="flex gap-1.5 w-full h-1.5">
         {Array.from({length: total}).map((_, i) => (
           <div key={i} className={`flex-1 rounded-full transition-all duration-300 ${i < current ? 'bg-primary dark:bg-primary-dark' : i === current ? 'bg-slate-300 dark:bg-slate-600 animate-pulse' : 'bg-slate-200 dark:bg-slate-800'}`} />
         ))}
      </div>
    );

    const SyncStatus = ({ status }) => {
       if(status === 'syncing') return <div className="w-2 h-2 rounded-full bg-accent animate-pulse shadow-[0_0_8px_currentColor]" title="Sync..."></div>;
       if(status === 'error') return <div className="w-2 h-2 rounded-full bg-danger" title="Offline"></div>;
       return <div className="w-2 h-2 rounded-full bg-success shadow-[0_0_8px_currentColor]" title="Synced"></div>;
    };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false }; }
      static getDerivedStateFromError(error) { return { hasError: true }; }
      componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
      render() {
        if (this.state.hasError) return <div className="p-8 text-center text-danger">Ein Fehler ist aufgetreten.<br/><button onClick={()=>window.location.reload()} className="underline mt-2">Neu laden</button></div>;
        return this.props.children;
      }
    }

    /* ================= FEATURE COMPONENTS ================= */
    
    // --- Auth ---
    const AuthScreen = ({ userManager, onLogin }) => {
       const [isRegister, setIsRegister] = useState(false);
       const [name, setName] = useState("");
       const [pwd, setPwd] = useState("");
       const [code, setCode] = useState("");
       const [error, setError] = useState("");

       const handleSubmit = (e) => {
          e.preventDefault();
          setError("");
          try {
             const res = isRegister ? userManager.register(name, pwd, code) : userManager.login(name, pwd);
             if(res.success) onLogin(res.user); else setError(res.error);
          } catch(err) { setError(err.message || String(err)); }
       };

       return (
          <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden bg-bg-light dark:bg-bg-dark">
             {/* Decor */}
             <div className="absolute -top-20 -left-20 w-64 h-64 bg-primary/20 rounded-full blur-3xl"></div>
             <div className="absolute -bottom-20 -right-20 w-80 h-80 bg-accent/20 rounded-full blur-3xl"></div>
             
             <div className="relative glass w-full max-w-sm p-8 rounded-[2rem] border border-white/20 shadow-2xl space-y-8 animate-scale-in">
                <div className="text-center">
                   <h1 className="text-3xl font-black tracking-tighter mb-1 text-slate-800 dark:text-white">Lerntool<span className="text-primary">.</span></h1>
                   <p className="text-slate-500 text-sm font-medium">Dein Begleiter für E1/E2a</p>
                </div>
                
                <div className="flex bg-slate-100 dark:bg-slate-800/50 p-1.5 rounded-2xl">
                   <button onClick={()=>setIsRegister(false)} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${!isRegister ? 'bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>Anmelden</button>
                   <button onClick={()=>setIsRegister(true)} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${isRegister ? 'bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>Registrieren</button>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4">
                   <input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-primary transition-colors font-medium text-slate-800 dark:text-white" placeholder="Benutzername" value={name} onChange={e=>setName(e.target.value)} required />
                   <input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-primary transition-colors font-medium text-slate-800 dark:text-white" type="password" placeholder="Passwort" value={pwd} onChange={e=>setPwd(e.target.value)} required />
                   {isRegister && <input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-primary transition-colors font-medium text-slate-800 dark:text-white" placeholder="Admin Code (Optional)" value={code} onChange={e=>setCode(e.target.value)} />}
                   
                   {error && <div className="text-danger text-sm text-center font-medium bg-danger/10 p-2 rounded-lg">{error}</div>}
                   <Button fullWidth size="lg" className="shadow-primary/30 mt-2">{isRegister ? 'Starten' : 'Los geht\'s'}</Button>
                </form>
             </div>
          </div>
       );
    };

    // --- Profile ---
    const ProfileScreen = ({ user, userManager, onLogout }) => {
       const [pwd, setPwd] = useState("");
       const handlePwd = (e) => { e.preventDefault(); if(pwd.length < 4) return alert("Zu kurz"); userManager.updatePassword(user.id, pwd); alert("Passwort geändert"); setPwd(""); };
       return (
          <div className="p-6 space-y-6 pt-12 animate-fade-in">
             <div className="text-center space-y-2">
                <div className="w-24 h-24 bg-gradient-to-br from-primary to-accent rounded-[2rem] mx-auto flex items-center justify-center text-4xl font-black text-white shadow-xl shadow-primary/30">{user.username.charAt(0)}</div>
                <h2 className="text-2xl font-bold dark:text-white">{user.username}</h2>
                <span className="inline-block px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-xs font-bold uppercase text-slate-500 tracking-wider">{user.role}</span>
             </div>

             <div className="bg-surface-light dark:bg-surface-dark p-6 rounded-3xl border border-border-light dark:border-border-dark shadow-sm">
                <h3 className="font-bold mb-4 flex items-center gap-2 dark:text-white"><Icons.Settings className="w-5 h-5"/> Sicherheit</h3>
                <form onSubmit={handlePwd} className="flex gap-2">
                   <input className="flex-1 px-4 py-2 border border-border-light dark:border-border-dark rounded-xl bg-transparent outline-none focus:border-primary dark:text-white" type="password" placeholder="Neues Passwort" value={pwd} onChange={e=>setPwd(e.target.value)} />
                   <Button size="sm">Update</Button>
                </form>
             </div>
             <Button fullWidth variant="ghost" onClick={onLogout} className="text-danger hover:bg-danger/10">Abmelden</Button>
          </div>
       );
    };

    // --- Admin ---
    const AdminPanel = ({ questions, qManager }) => {
       const [search, setSearch] = useState("");
       const [editQ, setEditQ] = useState(null);
       const fileRef = useRef(null);
       const filtered = questions.filter(q => q.question.toLowerCase().includes(search.toLowerCase()) || q.id.toLowerCase().includes(search.toLowerCase()));

       const handleSave = (e) => {
          e.preventDefault(); const formData = new FormData(e.target);
          const newQ = { id: editQ.id || generateId("q"), question: formData.get("question"), choices: [0,1,2,3,4].map(i => formData.get(`c${i}`)), correct: [0,1,2,3,4].filter(i => formData.get(`chk${i}`)).map(Number), explain: formData.get("explain"), law_ref: formData.get("law"), tags: formData.get("tags").split(",").map(t=>t.trim()).filter(Boolean), difficulty: 1 };
          qManager.save(newQ); setEditQ(null);
       };

       const handleImport = async (e) => {
          const file = e.target.files?.[0]; if(!file) return;
          try { const text = await file.text(); const data = JSON.parse(text); if(!Array.isArray(data)) throw new Error("Array required"); for(const q of data) { if(q.question) { if(!q.id) q.id = generateId("q"); await qManager.save({ id: q.id, question: q.question, choices: q.choices, correct: q.correct||[], explain: q.explain||"", law_ref: q.law_ref||"", tags: q.tags||[], difficulty: q.difficulty||1 }); } } alert("Import success!"); } catch(err) { alert(err.message); } e.target.value = null;
       };

       return (
          <div className="p-6 space-y-6 pt-8 pb-32 animate-fade-in">
             <div className="flex gap-2">
                <input className="flex-1 px-4 py-2 rounded-2xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark outline-none dark:text-white" placeholder="Fragen suchen..." value={search} onChange={e=>setSearch(e.target.value)} />
                <input type="file" ref={fileRef} onChange={handleImport} className="hidden" accept=".json" />
                <Button variant="outline" onClick={()=>fileRef.current.click()}><Icons.Upload className="w-5 h-5"/></Button>
                <Button onClick={()=>setEditQ({id:"", question:"", choices:["","","","",""], correct:[], tags:[], explain:"", law_ref:""})}>Neu</Button>
             </div>

             <div className="grid gap-3">
                {filtered.map(q => (
                   <div key={q.id} className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark flex gap-4 group">
                      <div className="flex-1 min-w-0">
                         <div className="font-bold text-sm truncate dark:text-white">{q.question}</div>
                         <div className="text-xs text-slate-400 mt-1 flex gap-2">
                           <span className="bg-slate-100 dark:bg-slate-700 px-1.5 rounded">{q.id}</span>
                           <span>{q.tags.join(", ")}</span>
                         </div>
                      </div>
                      <div className="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                         <button onClick={()=>setEditQ(q)} className="text-primary hover:text-primary-dark"><Icons.Edit className="w-5 h-5"/></button>
                         <button onClick={()=>{if(confirm("Löschen?")) qManager.remove(q.id)}} className="text-danger hover:text-danger-dark"><Icons.Trash className="w-5 h-5"/></button>
                      </div>
                   </div>
                ))}
             </div>

             {editQ && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                   <form onSubmit={handleSave} className="bg-surface-light dark:bg-surface-dark w-full max-w-lg rounded-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto space-y-4 border border-border-light dark:border-border-dark">
                      <h2 className="font-black text-xl dark:text-white">{editQ.id ? 'Bearbeiten' : 'Erstellen'}</h2>
                      <textarea name="question" defaultValue={editQ.question} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl font-medium dark:text-white outline-none focus:border-primary" placeholder="Die Frage..." required rows={3}/>
                      <div className="space-y-2">
                         <label className="text-xs font-bold uppercase text-slate-400">Antworten (Check = Korrekt)</label>
                         {editQ.choices.map((c, i) => (
                            <div key={i} className="flex gap-3 items-center">
                               <input type="checkbox" name={`chk${i}`} defaultChecked={editQ.correct.includes(i)} className="w-5 h-5 accent-success rounded" />
                               <input name={`c${i}`} defaultValue={c} className="flex-1 p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder={`Option ${i+1}`} required />
                            </div>
                         ))}
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                         <input name="tags" defaultValue={editQ.tags.join(", ")} className="p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder="Tags (BDG, SPG)" />
                         <input name="law" defaultValue={editQ.law_ref} className="p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder="§ Gesetz" />
                      </div>
                      <textarea name="explain" defaultValue={editQ.explain} className="w-full p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder="Erklärung..." rows={2}/>
                      <div className="flex gap-2 pt-2">
                         <Button type="button" variant="ghost" onClick={()=>setEditQ(null)} fullWidth>Abbruch</Button>
                         <Button type="submit" fullWidth>Speichern</Button>
                      </div>
                   </form>
                </div>
             )}
          </div>
       );
    };

    // --- Training (True/False with point scoring) ---
    const TrainingMode = ({ questions, userData, setUserData, onExit, filterTag }) => {
       const [queue, setQueue] = useState([]);
       const [qIndex, setQIndex] = useState(0);
       const [feedbackMode, setFeedbackMode] = useState(false);
       const [currentMarks, setCurrentMarks] = useState({}); // { choiceIndex: 'true'|'false'|null }
       const [lastPoints, setLastPoints] = useState(0);
       const [loading, setLoading] = useState(true);
       const sessionStatsRef = useRef({ totalPoints: 0, totalMaxPoints: 0, questionsAnswered: 0 });
       const exitWithStats = () => onExit(sessionStatsRef.current.totalPoints, sessionStatsRef.current.totalMaxPoints, sessionStatsRef.current.questionsAnswered);

       useEffect(() => {
          if(!questions || queue.length > 0) return;
          setLoading(true);
          let pool = questions;
          if(filterTag) {
            if(typeof filterTag === 'string') {
               pool = pool.filter(q => q.tags && q.tags.some(t => t.toLowerCase() === filterTag.toLowerCase()));
            } else if (typeof filterTag === 'object') {
               const getTier = (id) => (userData.tiers||{})[id] || 1;
               if(filterTag.status === 'new') pool = pool.filter(q => getTier(q.id) === 1);
               if(filterTag.status === 'wip') pool = pool.filter(q => getTier(q.id) > 1 && getTier(q.id) < 4);
               if(filterTag.status === 'mastered') pool = pool.filter(q => getTier(q.id) >= 4);
            }
          }
          const tiers = (id) => (userData.tiers || {})[id] || 1;
          const newQueue = weightedOrder(pool, tiers, "seed-"+Date.now());
          setQueue(newQueue); setQIndex(0); setLoading(false);
       }, [questions, filterTag, userData.tiers]);

       const handleCheck = () => {
          const currentQ = queue[qIndex];
          const points = scoreQuestion(currentQ, currentMarks);
          const maxPoints = (currentQ.choices || []).length;
          setLastPoints(points);
          setFeedbackMode(true);
          sessionStatsRef.current.totalPoints += points;
          sessionStatsRef.current.totalMaxPoints += maxPoints;
          sessionStatsRef.current.questionsAnswered += 1;
          // Update tiers: 5/5 → tier up, 0 → tier down, else stay
          const newTiers = { ...(userData.tiers || {}) }; const curTier = newTiers[currentQ.id] || 1;
          if(points >= 4) newTiers[currentQ.id] = Math.min(5, curTier + 1);
          else if(points <= 1) newTiers[currentQ.id] = Math.max(1, curTier - 1);
          setUserData(prev => ({ ...prev, tiers: newTiers, score: (prev.score||0) + points * 2 }));
       };
       const handleNext = () => { setFeedbackMode(false); setCurrentMarks({}); if(qIndex < queue.length - 1) setQIndex(i => i + 1); else setQueue([]); };
       const hasAnyMark = Object.values(currentMarks).some(v => v !== null && v !== undefined);

       if(loading) return <div className="min-h-screen flex items-center justify-center text-primary font-bold animate-pulse">Lade Training...</div>;
       if(!queue.length) return <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center space-y-6"><div className="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-3xl flex items-center justify-center"><Icons.Check className="w-12 h-12 text-slate-400"/></div><h2 className="text-xl font-bold dark:text-white">Alles erledigt!</h2><p className="text-slate-500">Für heute gibt es keine Fragen mehr in dieser Kategorie.</p><Button onClick={exitWithStats}>Zurück</Button></div>;

       const currentQ = queue[qIndex];

       return (
         <div className="h-screen flex flex-col bg-bg-light dark:bg-bg-dark relative overflow-hidden">
            {/* Progress Header */}
            <div className="px-6 pt-12 pb-4 flex items-center gap-4">
               <button onClick={exitWithStats} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><Icons.X className="w-6 h-6"/></button>
               <SegmentedProgress current={qIndex} total={queue.length} />
            </div>

            {/* Question Card */}
            <div className="flex-1 overflow-y-auto px-6 pb-44">
               <div className="max-w-xl mx-auto space-y-6 py-4 animate-slide-up">
                  <div className="space-y-2">
                     <span className="text-xs font-bold uppercase tracking-wider text-primary dark:text-primary-light/80">Level {(userData.tiers||{})[currentQ.id] || 1}</span>
                     <h2 className="text-xl font-bold text-slate-900 dark:text-white leading-snug">{currentQ.question}</h2>
                     {!feedbackMode && <p className="text-[10px] font-bold text-slate-400 uppercase">Bewerte jede Aussage als Richtig oder Falsch:</p>}
                  </div>

                  <div className="space-y-3">
                     {(currentQ.choices || []).map((txt, ci) => {
                        const mark = currentMarks[ci] || null;
                        const isCorrectChoice = (currentQ.correct || []).includes(ci);

                        if(feedbackMode) {
                           let pointResult = 0;
                           if(mark === 'true') pointResult = isCorrectChoice ? 1 : -1;
                           else if(mark === 'false') pointResult = isCorrectChoice ? -1 : 1;
                           const bgColor = pointResult === 1 ? 'border-success bg-success/10' : pointResult === -1 ? 'border-danger bg-danger/10' : 'border-border-light dark:border-border-dark bg-slate-50 dark:bg-slate-800/50';
                           return (
                              <div key={ci} className={`p-3 rounded-2xl border-2 transition-all ${bgColor}`}>
                                 <div className="flex items-start gap-3">
                                    <div className={`w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center text-xs font-mono font-bold text-white mt-0.5 ${pointResult === 1 ? 'bg-success' : pointResult === -1 ? 'bg-danger' : 'bg-slate-400'}`}>
                                       {pointResult === 1 ? '+1' : pointResult === -1 ? '-1' : ' 0'}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                       <span className="font-medium text-sm text-slate-700 dark:text-slate-200 leading-relaxed">{txt}</span>
                                       <div className="flex gap-3 mt-1 text-[10px] font-bold">
                                          <span className={isCorrectChoice ? 'text-success' : 'text-danger'}>{isCorrectChoice ? 'Wahr' : 'Falsch'}</span>
                                          <span className="text-slate-400">Deine Bewertung: {mark === 'true' ? 'Richtig' : mark === 'false' ? 'Falsch' : 'Keine'}</span>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           );
                        }

                        return (
                           <div key={ci} className={`p-3 rounded-2xl border-2 transition-all duration-200 ${mark === 'true' ? 'border-success bg-success/5' : mark === 'false' ? 'border-danger bg-danger/5' : 'border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark'}`}>
                              <div className="flex items-start gap-3">
                                 <span className="text-sm font-medium text-slate-700 dark:text-slate-200 flex-1 leading-relaxed pt-1">{txt}</span>
                                 <div className="flex gap-1 flex-shrink-0">
                                    <button onClick={() => setCurrentMarks(prev => ({ ...prev, [ci]: prev[ci] === 'true' ? null : 'true' }))}
                                       className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${mark === 'true' ? 'bg-success text-white shadow-md shadow-success/30' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 hover:bg-success/20 hover:text-success'}`}>
                                       <Icons.Check className="w-5 h-5" strokeWidth={3} />
                                    </button>
                                    <button onClick={() => setCurrentMarks(prev => ({ ...prev, [ci]: prev[ci] === 'false' ? null : 'false' }))}
                                       className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${mark === 'false' ? 'bg-danger text-white shadow-md shadow-danger/30' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 hover:bg-danger/20 hover:text-danger'}`}>
                                       <Icons.X className="w-5 h-5" strokeWidth={3} />
                                    </button>
                                 </div>
                              </div>
                           </div>
                        );
                     })}
                  </div>
               </div>
            </div>

            {/* Bottom Actions */}
            <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-bg-light dark:from-bg-dark via-bg-light dark:via-bg-dark to-transparent safe-pb">
               <div className="max-w-xl mx-auto">
                  {!feedbackMode ? (
                     <Button size="lg" fullWidth onClick={handleCheck} disabled={!hasAnyMark} className="shadow-xl">Bestätigen</Button>
                  ) : (
                     <div className={`p-5 rounded-3xl animate-scale-in border ${lastPoints >= 4 ? 'bg-success/10 border-success/20' : lastPoints >= 2 ? 'bg-warning/10 border-warning/20' : 'bg-danger/10 border-danger/20'} glass`}>
                        <div className="flex justify-between items-start mb-4">
                           <div>
                              <div className="flex items-center gap-3">
                                 <div className={`text-xl font-black ${lastPoints >= 4 ? 'text-success' : lastPoints >= 2 ? 'text-warning' : 'text-danger'}`}>
                                    {lastPoints >= 4 ? 'Stark!' : lastPoints >= 2 ? 'Solide' : 'Knapp daneben'}
                                 </div>
                                 <div className={`px-3 py-1 rounded-full font-black text-sm ${lastPoints >= 4 ? 'bg-success/20 text-success' : lastPoints >= 2 ? 'bg-warning/20 text-warning' : 'bg-danger/20 text-danger'}`}>
                                    {lastPoints}/5 Punkte
                                 </div>
                              </div>
                              {currentQ.explain && <p className="text-sm mt-2 text-slate-600 dark:text-slate-300 font-medium">{currentQ.explain}</p>}
                              {currentQ.law_ref && <p className="text-xs mt-2 font-mono text-slate-400 bg-white/50 dark:bg-black/20 inline-block px-1.5 py-0.5 rounded">{currentQ.law_ref}</p>}
                           </div>
                        </div>
                        <Button onClick={handleNext} variant={lastPoints >= 4 ? 'success' : lastPoints >= 2 ? 'primary' : 'danger'} fullWidth>Weiter</Button>
                     </div>
                  )}
               </div>
            </div>
         </div>
       );
    };

    // --- Exam Mode ---
    const ExamMode = ({ questions, userData, setUserData, onExit, onFinish }) => {
       const [phase, setPhase] = useState('setup'); // setup | running | review
       const [numQuestions, setNumQuestions] = useState(20);
       const [timePerQuestion, setTimePerQuestion] = useState(60); // seconds per question
       const [queue, setQueue] = useState([]);
       const [qIndex, setQIndex] = useState(0);
       const [answers, setAnswers] = useState({}); // { qIndex: [selectedIndices] }
       const [currentSelection, setCurrentSelection] = useState([]);
       const [timeLeft, setTimeLeft] = useState(0);
       const timerRef = useRef(null);

       const startExam = () => {
          const pool = [...questions];
          const shuffled = pool.sort(() => Math.random() - 0.5).slice(0, Math.min(numQuestions, pool.length));
          setQueue(shuffled);
          setQIndex(0);
          setAnswers({});
          setCurrentSelection([]);
          setTimeLeft(shuffled.length * timePerQuestion);
          setPhase('running');
       };

       // Timer
       useEffect(() => {
          if(phase !== 'running') return;
          timerRef.current = setInterval(() => {
             setTimeLeft(prev => {
                if(prev <= 1) { clearInterval(timerRef.current); setPhase('review'); return 0; }
                return prev - 1;
             });
          }, 1000);
          return () => clearInterval(timerRef.current);
       }, [phase]);

       const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

       const confirmAnswer = () => {
          const newAnswers = { ...answers, [qIndex]: currentSelection };
          setAnswers(newAnswers);
          if(qIndex < queue.length - 1) {
             setQIndex(qIndex + 1);
             setCurrentSelection(newAnswers[qIndex + 1] || []);
          } else {
             clearInterval(timerRef.current);
             setPhase('review');
          }
       };

       const jumpTo = (i) => {
          const newAnswers = { ...answers, [qIndex]: currentSelection };
          setAnswers(newAnswers);
          setQIndex(i);
          setCurrentSelection(newAnswers[i] || []);
       };

       const finishExam = () => {
          clearInterval(timerRef.current);
          const finalAnswers = { ...answers, [qIndex]: currentSelection };
          setAnswers(finalAnswers);
          setPhase('review');
       };

       // Calculate results
       const getResults = () => {
          let correct = 0;
          let wrong = 0;
          let unanswered = 0;
          const details = queue.map((q, i) => {
             const sel = answers[i] || [];
             if(sel.length === 0) { unanswered++; return { q, sel, isCorrect: false, status: 'unanswered' }; }
             const isCorrect = JSON.stringify(sel.sort()) === JSON.stringify(q.correct.sort());
             if(isCorrect) correct++; else wrong++;
             return { q, sel, isCorrect, status: isCorrect ? 'correct' : 'wrong' };
          });
          const percentage = queue.length > 0 ? Math.round((correct / queue.length) * 100) : 0;
          let grade = 'Nicht bestanden';
          if(percentage >= 90) grade = 'Sehr gut';
          else if(percentage >= 75) grade = 'Gut';
          else if(percentage >= 60) grade = 'Befriedigend';
          else if(percentage >= 50) grade = 'Bestanden';
          return { correct, wrong, unanswered, percentage, grade, details, passed: percentage >= 50 };
       };

       // --- SETUP ---
       if(phase === 'setup') {
          return (
             <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-bg-light dark:bg-bg-dark animate-fade-in">
                <div className="w-full max-w-md space-y-8">
                   <div className="text-center space-y-2">
                      <div className="w-20 h-20 bg-gradient-to-br from-warning to-danger rounded-[1.5rem] mx-auto flex items-center justify-center shadow-xl">
                         <Icons.Target className="w-10 h-10 text-white" />
                      </div>
                      <h2 className="text-2xl font-black dark:text-white">Prüfungsmodus</h2>
                      <p className="text-slate-500 text-sm">Simuliere eine echte Prüfung ohne Feedback</p>
                   </div>

                   <div className="bg-surface-light dark:bg-surface-dark p-6 rounded-3xl border border-border-light dark:border-border-dark space-y-5">
                      <div>
                         <label className="text-xs font-bold uppercase text-slate-400 mb-2 block">Anzahl Fragen</label>
                         <div className="flex gap-2">
                            {[10, 20, 30, 50].map(n => (
                               <button key={n} onClick={() => setNumQuestions(n)}
                                  className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${numQuestions === n ? 'bg-primary text-white shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700'}`}>
                                  {n}
                               </button>
                            ))}
                         </div>
                      </div>
                      <div>
                         <label className="text-xs font-bold uppercase text-slate-400 mb-2 block">Zeit pro Frage (Sek.)</label>
                         <div className="flex gap-2">
                            {[30, 45, 60, 90].map(t => (
                               <button key={t} onClick={() => setTimePerQuestion(t)}
                                  className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${timePerQuestion === t ? 'bg-primary text-white shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700'}`}>
                                  {t}s
                               </button>
                            ))}
                         </div>
                      </div>
                      <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl text-center">
                         <span className="text-xs text-slate-400">Gesamtzeit: </span>
                         <span className="font-bold text-primary">{formatTime(Math.min(numQuestions, questions.length) * timePerQuestion)}</span>
                         <span className="text-xs text-slate-400 ml-2">({Math.min(numQuestions, questions.length)} Fragen)</span>
                      </div>
                   </div>

                   <div className="space-y-3">
                      <Button size="lg" fullWidth onClick={startExam} className="shadow-xl bg-gradient-to-r from-warning to-danger border-0">
                         <Icons.Clock className="w-5 h-5" /> Prüfung starten
                      </Button>
                      <Button variant="ghost" fullWidth onClick={onExit}>Zurück</Button>
                   </div>
                </div>
             </div>
          );
       }

       // --- RUNNING ---
       if(phase === 'running') {
          const currentQ = queue[qIndex];
          const toggleSel = (i) => setCurrentSelection(prev => prev.includes(i) ? prev.filter(x=>x!==i) : [...prev, i]);
          const answeredCount = Object.keys(answers).filter(k => (answers[k] || []).length > 0).length + (currentSelection.length > 0 ? 1 : 0);
          const urgency = timeLeft < 60 ? 'text-danger animate-pulse' : timeLeft < 180 ? 'text-warning' : 'text-primary';

          return (
             <div className="h-screen flex flex-col bg-bg-light dark:bg-bg-dark relative overflow-hidden">
                {/* Timer Header */}
                <div className="px-6 pt-12 pb-2 space-y-3">
                   <div className="flex items-center justify-between">
                      <button onClick={() => { if(confirm('Prüfung wirklich abbrechen?')) { clearInterval(timerRef.current); onExit(); }}} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                         <Icons.X className="w-6 h-6"/>
                      </button>
                      <div className={`flex items-center gap-2 font-mono font-black text-xl ${urgency}`}>
                         <Icons.Clock className="w-5 h-5" />
                         {formatTime(timeLeft)}
                      </div>
                      <button onClick={finishExam} className="text-xs font-bold text-primary bg-primary/10 px-3 py-1.5 rounded-full hover:bg-primary/20">
                         Abgeben
                      </button>
                   </div>
                   <SegmentedProgress current={qIndex} total={queue.length} />
                   <div className="text-xs text-slate-400 text-center font-medium">Frage {qIndex + 1} / {queue.length} · {answeredCount} beantwortet</div>
                </div>

                {/* Question */}
                <div className="flex-1 overflow-y-auto px-6 pb-40">
                   <div className="max-w-xl mx-auto space-y-6 py-4">
                      <h2 className="text-xl font-bold text-slate-900 dark:text-white leading-snug">{currentQ.question}</h2>
                      <div className="space-y-3">
                         {currentQ.choices.map((txt, i) => {
                            const sel = currentSelection.includes(i);
                            return (
                               <div key={i} onClick={() => toggleSel(i)} className={`p-4 rounded-2xl border-2 cursor-pointer transition-all duration-200 flex items-start gap-4 ${sel ? 'border-primary bg-primary/5 text-primary-dark dark:text-primary shadow-[0_0_0_1px_rgba(99,102,241,1)]' : 'border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                  <div className={`w-6 h-6 rounded-lg border-2 flex-shrink-0 flex items-center justify-center transition-colors mt-0.5 ${sel ? 'border-primary bg-primary' : 'border-slate-300 dark:border-slate-600'}`}>
                                     {sel && <Icons.Check className="w-4 h-4 text-white" strokeWidth={4} />}
                                  </div>
                                  <span className="font-medium text-base leading-relaxed">{txt}</span>
                               </div>
                            );
                         })}
                      </div>
                   </div>
                </div>

                {/* Navigation */}
                <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-bg-light dark:from-bg-dark via-bg-light dark:via-bg-dark to-transparent safe-pb">
                   <div className="max-w-xl mx-auto space-y-3">
                      <div className="flex gap-2">
                         <Button variant="outline" onClick={() => qIndex > 0 && jumpTo(qIndex - 1)} disabled={qIndex === 0} className="flex-1">Zurück</Button>
                         <Button onClick={confirmAnswer} className="flex-1" disabled={!currentSelection.length}>
                            {qIndex === queue.length - 1 ? 'Abgeben' : 'Weiter'}
                         </Button>
                      </div>
                      {/* Question dots for navigation */}
                      <div className="flex flex-wrap gap-1.5 justify-center">
                         {queue.map((_, i) => {
                            const hasAnswer = (answers[i] || []).length > 0 || (i === qIndex && currentSelection.length > 0);
                            return (
                               <button key={i} onClick={() => jumpTo(i)}
                                  className={`w-7 h-7 rounded-lg text-[10px] font-bold transition-all ${i === qIndex ? 'bg-primary text-white scale-110' : hasAnswer ? 'bg-success/20 text-success border border-success/30' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}`}>
                                  {i + 1}
                               </button>
                            );
                         })}
                      </div>
                   </div>
                </div>
             </div>
          );
       }

       // --- REVIEW ---
       const results = getResults();
       return (
          <div className="min-h-screen bg-bg-light dark:bg-bg-dark p-6 pb-32 animate-fade-in">
             <div className="max-w-xl mx-auto space-y-8 pt-8">
                {/* Result Header */}
                <div className="text-center space-y-4">
                   <div className={`w-24 h-24 rounded-[2rem] mx-auto flex items-center justify-center shadow-xl ${results.passed ? 'bg-gradient-to-br from-success to-emerald-600' : 'bg-gradient-to-br from-danger to-red-700'}`}>
                      {results.passed ? <Icons.Check className="w-12 h-12 text-white" /> : <Icons.X className="w-12 h-12 text-white" />}
                   </div>
                   <div>
                      <h2 className="text-3xl font-black dark:text-white">{results.grade}</h2>
                      <p className="text-slate-500 mt-1">{results.percentage}% richtig</p>
                   </div>
                </div>

                {/* Stats Grid */}
                <div className="grid grid-cols-3 gap-3">
                   <div className="bg-success/10 border border-success/20 rounded-2xl p-4 text-center">
                      <div className="text-2xl font-black text-success">{results.correct}</div>
                      <div className="text-[10px] font-bold text-success/80 uppercase">Richtig</div>
                   </div>
                   <div className="bg-danger/10 border border-danger/20 rounded-2xl p-4 text-center">
                      <div className="text-2xl font-black text-danger">{results.wrong}</div>
                      <div className="text-[10px] font-bold text-danger/80 uppercase">Falsch</div>
                   </div>
                   <div className="bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 text-center">
                      <div className="text-2xl font-black text-slate-500">{results.unanswered}</div>
                      <div className="text-[10px] font-bold text-slate-400 uppercase">Offen</div>
                   </div>
                </div>

                {/* Detail Review */}
                <div className="space-y-3">
                   <h3 className="font-bold text-lg dark:text-white">Detailauswertung</h3>
                   {results.details.map((d, i) => (
                      <div key={i} className={`p-4 rounded-2xl border ${d.status === 'correct' ? 'bg-success/5 border-success/20' : d.status === 'wrong' ? 'bg-danger/5 border-danger/20' : 'bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700'}`}>
                         <div className="flex items-start gap-3">
                            <div className={`w-7 h-7 rounded-lg flex-shrink-0 flex items-center justify-center text-xs font-bold text-white ${d.status === 'correct' ? 'bg-success' : d.status === 'wrong' ? 'bg-danger' : 'bg-slate-400'}`}>{i+1}</div>
                            <div className="flex-1 min-w-0">
                               <p className="font-medium text-sm text-slate-800 dark:text-slate-200 leading-relaxed">{d.q.question}</p>
                               <div className="mt-2 space-y-1">
                                  {d.q.choices.map((c, ci) => {
                                     const wasSelected = d.sel.includes(ci);
                                     const isCorrectChoice = d.q.correct.includes(ci);
                                     return (
                                        <div key={ci} className={`text-xs px-2 py-1 rounded-lg flex items-center gap-2 ${isCorrectChoice ? 'text-success font-bold' : wasSelected ? 'text-danger font-bold' : 'text-slate-400'}`}>
                                           {isCorrectChoice ? <Icons.Check className="w-3 h-3"/> : wasSelected ? <Icons.X className="w-3 h-3"/> : <span className="w-3"/>}
                                           {c}
                                        </div>
                                     );
                                  })}
                               </div>
                               {d.q.explain && <p className="text-xs text-slate-500 mt-2 italic">{d.q.explain}</p>}
                               {d.q.law_ref && <p className="text-[10px] font-mono text-slate-400 mt-1">{d.q.law_ref}</p>}
                            </div>
                         </div>
                      </div>
                   ))}
                </div>

                <Button size="lg" fullWidth onClick={onExit} className="shadow-xl">Zurück zur Übersicht</Button>
             </div>
          </div>
       );
    };

    // --- Real Exam Mode (Multiple True-False, 56 Questions, 7 Categories x 8) ---
    const EXAM_CATEGORIES = ["BDG", "SPG", "StPO", "StGB", "Verkehr", "Verfassung", "Verwaltung"];
    const QUESTIONS_PER_CATEGORY = 8;
    const TOTAL_EXAM_QUESTIONS = EXAM_CATEGORIES.length * QUESTIONS_PER_CATEGORY; // 56

    const RealExamMode = ({ questions, onExit }) => {
       const [phase, setPhase] = useState('setup'); // setup | running | review
       const [queue, setQueue] = useState([]);
       const [qIndex, setQIndex] = useState(0);
       // answers: { [qIndex]: { [choiceIndex]: 'true' | 'false' | null } }
       const [answers, setAnswers] = useState({});
       const [currentMarks, setCurrentMarks] = useState({});
       const [timeLeft, setTimeLeft] = useState(0);
       const [categoryMap, setCategoryMap] = useState([]); // tracks which category each question belongs to
       const timerRef = useRef(null);

       const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

       // Check availability
       const getCategoryAvailability = () => {
          return EXAM_CATEGORIES.map(cat => {
             const pool = questions.filter(q => q.tags?.some(t => t.toLowerCase() === cat.toLowerCase()));
             return { name: cat, available: pool.length, enough: pool.length >= QUESTIONS_PER_CATEGORY };
          });
       };

       const canStartExam = () => getCategoryAvailability().every(c => c.enough);

       const startExam = () => {
          const selectedQuestions = [];
          const catMapping = [];
          for(const cat of EXAM_CATEGORIES) {
             const pool = questions.filter(q => q.tags?.some(t => t.toLowerCase() === cat.toLowerCase()));
             const shuffled = [...pool].sort(() => Math.random() - 0.5).slice(0, QUESTIONS_PER_CATEGORY);
             shuffled.forEach(q => {
                selectedQuestions.push(q);
                catMapping.push(cat);
             });
          }
          setQueue(selectedQuestions);
          setCategoryMap(catMapping);
          setQIndex(0);
          setAnswers({});
          setCurrentMarks({});
          // 60 seconds per question = 56 minutes total
          setTimeLeft(TOTAL_EXAM_QUESTIONS * 60);
          setPhase('running');
       };

       // Timer
       useEffect(() => {
          if(phase !== 'running') return;
          timerRef.current = setInterval(() => {
             setTimeLeft(prev => {
                if(prev <= 1) { clearInterval(timerRef.current); finishExam(); return 0; }
                return prev - 1;
             });
          }, 1000);
          return () => clearInterval(timerRef.current);
       }, [phase]);

       const toggleMark = (choiceIndex) => {
          setCurrentMarks(prev => {
             const current = prev[choiceIndex] || null;
             // Cycle: null -> 'true' -> 'false' -> null
             let next;
             if(current === null) next = 'true';
             else if(current === 'true') next = 'false';
             else next = null;
             return { ...prev, [choiceIndex]: next };
          });
       };

       const saveAndGo = (targetIndex) => {
          const newAnswers = { ...answers, [qIndex]: { ...currentMarks } };
          setAnswers(newAnswers);
          setQIndex(targetIndex);
          setCurrentMarks(newAnswers[targetIndex] || {});
       };

       const goNext = () => {
          const newAnswers = { ...answers, [qIndex]: { ...currentMarks } };
          setAnswers(newAnswers);
          if(qIndex < queue.length - 1) {
             const nextIdx = qIndex + 1;
             setQIndex(nextIdx);
             setCurrentMarks(newAnswers[nextIdx] || {});
          } else {
             finishExam();
          }
       };

       const goPrev = () => {
          if(qIndex > 0) saveAndGo(qIndex - 1);
       };

       const finishExam = () => {
          clearInterval(timerRef.current);
          const finalAnswers = { ...answers, [qIndex]: { ...currentMarks } };
          setAnswers(finalAnswers);
          setPhase('review');
       };

       const getResults = () => {
          let totalPoints = 0;
          const maxPoints = queue.length * 5; // 280
          const perCategory = {};
          EXAM_CATEGORIES.forEach(c => { perCategory[c] = { points: 0, max: QUESTIONS_PER_CATEGORY * 5, questions: [] }; });

          const details = queue.map((q, i) => {
             const marks = answers[i] || {};
             const points = scoreQuestion(q, marks);
             totalPoints += points;
             const cat = categoryMap[i];
             if(perCategory[cat]) {
                perCategory[cat].points += points;
                perCategory[cat].questions.push({ q, marks, points, index: i });
             }
             return { q, marks, points, cat };
          });

          const percentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
          let grade = 'Nicht bestanden';
          if(percentage >= 90) grade = 'Sehr gut';
          else if(percentage >= 75) grade = 'Gut';
          else if(percentage >= 60) grade = 'Befriedigend';
          else if(percentage >= 50) grade = 'Bestanden';

          return { totalPoints, maxPoints, percentage, grade, passed: percentage >= 50, details, perCategory };
       };

       // --- SETUP ---
       if(phase === 'setup') {
          const availability = getCategoryAvailability();
          const ready = availability.every(c => c.enough);
          return (
             <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-bg-light dark:bg-bg-dark animate-fade-in">
                <div className="w-full max-w-md space-y-8">
                   <div className="text-center space-y-2">
                      <div className="w-20 h-20 bg-gradient-to-br from-red-600 to-red-900 rounded-[1.5rem] mx-auto flex items-center justify-center shadow-xl">
                         <Icons.Clipboard className="w-10 h-10 text-white" />
                      </div>
                      <h2 className="text-2xl font-black dark:text-white">Echte Prüfung</h2>
                      <p className="text-slate-500 text-sm">56 Fragen · 7 Fachbereiche · Multiple True-False</p>
                   </div>

                   {/* Rules */}
                   <div className="bg-surface-light dark:bg-surface-dark p-5 rounded-3xl border border-border-light dark:border-border-dark space-y-3">
                      <h3 className="font-bold text-sm dark:text-white">Prüfungsregeln</h3>
                      <div className="space-y-2 text-xs text-slate-500">
                         <div className="flex gap-2"><span className="font-bold text-slate-400">1.</span> Jede Frage hat 5 Aussagen. Bewerte jede als <span className="text-success font-bold">Richtig</span> oder <span className="text-danger font-bold">Falsch</span>.</div>
                         <div className="flex gap-2"><span className="font-bold text-slate-400">2.</span> Korrekte Bewertung: <span className="font-bold text-success">+1 Punkt</span>. Falsche Bewertung: <span className="font-bold text-danger">-1 Punkt</span>. Keine Bewertung: <span className="font-bold text-slate-400">0 Punkte</span>.</div>
                         <div className="flex gap-2"><span className="font-bold text-slate-400">3.</span> Minimum pro Frage: 0 Punkte (kein Negativsaldo).</div>
                         <div className="flex gap-2"><span className="font-bold text-slate-400">4.</span> Maximalpunktzahl: <span className="font-bold text-primary">280 Punkte</span> (56 × 5).</div>
                      </div>
                   </div>

                   {/* Category availability */}
                   <div className="bg-surface-light dark:bg-surface-dark p-5 rounded-3xl border border-border-light dark:border-border-dark space-y-3">
                      <h3 className="font-bold text-sm dark:text-white">Fachbereiche (je 8 Fragen)</h3>
                      <div className="space-y-2">
                         {availability.map(cat => (
                            <div key={cat.name} className="flex items-center justify-between">
                               <span className="text-sm font-medium dark:text-slate-200">{cat.name}</span>
                               <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${cat.enough ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>
                                  {cat.available} verfügbar {cat.enough ? '✓' : `(min. ${QUESTIONS_PER_CATEGORY})`}
                               </span>
                            </div>
                         ))}
                      </div>
                   </div>

                   <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl text-center">
                      <span className="text-xs text-slate-400">Zeitlimit: </span>
                      <span className="font-bold text-primary">{formatTime(TOTAL_EXAM_QUESTIONS * 60)}</span>
                      <span className="text-xs text-slate-400 ml-1">(60 Sek./Frage)</span>
                   </div>

                   <div className="space-y-3">
                      <Button size="lg" fullWidth onClick={startExam} disabled={!ready} className="shadow-xl bg-gradient-to-r from-red-600 to-red-800 border-0">
                         <Icons.Clipboard className="w-5 h-5" /> Prüfung starten
                      </Button>
                      <Button variant="ghost" fullWidth onClick={onExit}>Zurück</Button>
                   </div>
                </div>
             </div>
          );
       }

       // --- RUNNING ---
       if(phase === 'running') {
          const currentQ = queue[qIndex];
          const currentCat = categoryMap[qIndex];
          // Calculate which question number within the category
          const catStartIdx = EXAM_CATEGORIES.indexOf(currentCat) * QUESTIONS_PER_CATEGORY;
          const catQNum = qIndex - catStartIdx + 1;
          const answeredCount = Object.keys(answers).filter(k => {
             const m = answers[k] || {};
             return Object.values(m).some(v => v !== null);
          }).length + (Object.values(currentMarks).some(v => v !== null) ? 1 : 0);
          const urgency = timeLeft < 120 ? 'text-danger animate-pulse' : timeLeft < 300 ? 'text-warning' : 'text-primary';

          return (
             <div className="h-screen flex flex-col bg-bg-light dark:bg-bg-dark relative overflow-hidden">
                {/* Timer Header */}
                <div className="px-6 pt-12 pb-2 space-y-2">
                   <div className="flex items-center justify-between">
                      <button onClick={() => { if(confirm('Prüfung wirklich abbrechen?')) { clearInterval(timerRef.current); onExit(); }}} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                         <Icons.X className="w-6 h-6"/>
                      </button>
                      <div className={`flex items-center gap-2 font-mono font-black text-xl ${urgency}`}>
                         <Icons.Clock className="w-5 h-5" />
                         {formatTime(timeLeft)}
                      </div>
                      <button onClick={() => { if(confirm('Prüfung jetzt abgeben?')) finishExam(); }} className="text-xs font-bold text-danger bg-danger/10 px-3 py-1.5 rounded-full hover:bg-danger/20">
                         Abgeben
                      </button>
                   </div>
                   <div className="flex items-center justify-between text-xs">
                      <span className="font-bold text-primary bg-primary/10 px-2 py-0.5 rounded-full">{currentCat} ({catQNum}/{QUESTIONS_PER_CATEGORY})</span>
                      <span className="text-slate-400 font-medium">Frage {qIndex + 1} / {queue.length} · {answeredCount} bewertet</span>
                   </div>
                   <SegmentedProgress current={qIndex} total={queue.length} />
                </div>

                {/* Question + True/False Marking */}
                <div className="flex-1 overflow-y-auto px-6 pb-44">
                   <div className="max-w-xl mx-auto space-y-5 py-4">
                      <h2 className="text-lg font-bold text-slate-900 dark:text-white leading-snug">{currentQ.question}</h2>
                      <p className="text-[10px] font-bold text-slate-400 uppercase">Bewerte jede Aussage als Richtig oder Falsch:</p>
                      <div className="space-y-3">
                         {(currentQ.choices || []).map((txt, ci) => {
                            const mark = currentMarks[ci] || null;
                            return (
                               <div key={ci} className={`p-3 rounded-2xl border-2 transition-all duration-200 ${mark === 'true' ? 'border-success bg-success/5' : mark === 'false' ? 'border-danger bg-danger/5' : 'border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark'}`}>
                                  <div className="flex items-start gap-3">
                                     <span className="text-sm font-medium text-slate-700 dark:text-slate-200 flex-1 leading-relaxed pt-1">{txt}</span>
                                     <div className="flex gap-1 flex-shrink-0">
                                        <button onClick={() => setCurrentMarks(prev => ({ ...prev, [ci]: prev[ci] === 'true' ? null : 'true' }))}
                                           className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all text-sm font-bold ${mark === 'true' ? 'bg-success text-white shadow-md shadow-success/30' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 hover:bg-success/20 hover:text-success'}`}>
                                           <Icons.Check className="w-5 h-5" strokeWidth={3} />
                                        </button>
                                        <button onClick={() => setCurrentMarks(prev => ({ ...prev, [ci]: prev[ci] === 'false' ? null : 'false' }))}
                                           className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all text-sm font-bold ${mark === 'false' ? 'bg-danger text-white shadow-md shadow-danger/30' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 hover:bg-danger/20 hover:text-danger'}`}>
                                           <Icons.X className="w-5 h-5" strokeWidth={3} />
                                        </button>
                                     </div>
                                  </div>
                               </div>
                            );
                         })}
                      </div>
                   </div>
                </div>

                {/* Navigation */}
                <div className="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-bg-light dark:from-bg-dark via-bg-light dark:via-bg-dark to-transparent safe-pb">
                   <div className="max-w-xl mx-auto space-y-3">
                      <div className="flex gap-2">
                         <Button variant="outline" onClick={goPrev} disabled={qIndex === 0} className="flex-1">Zurück</Button>
                         <Button onClick={goNext} className="flex-1">
                            {qIndex === queue.length - 1 ? 'Abgeben' : 'Weiter'}
                         </Button>
                      </div>
                      {/* Category section indicators */}
                      <div className="flex gap-1 justify-center">
                         {EXAM_CATEGORIES.map((cat, catIdx) => {
                            const startIdx = catIdx * QUESTIONS_PER_CATEGORY;
                            const isCurrentCat = currentCat === cat;
                            const catAnswered = Array.from({length: QUESTIONS_PER_CATEGORY}, (_, i) => {
                               const idx = startIdx + i;
                               if(idx === qIndex) return Object.values(currentMarks).some(v => v !== null);
                               const m = answers[idx] || {};
                               return Object.values(m).some(v => v !== null);
                            }).filter(Boolean).length;
                            return (
                               <button key={cat} onClick={() => saveAndGo(startIdx)}
                                  className={`px-2 py-1 rounded-lg text-[9px] font-bold transition-all ${isCurrentCat ? 'bg-primary text-white scale-105' : catAnswered === QUESTIONS_PER_CATEGORY ? 'bg-success/20 text-success border border-success/30' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}`}>
                                  {cat} {catAnswered > 0 && <span className="opacity-70">{catAnswered}/{QUESTIONS_PER_CATEGORY}</span>}
                               </button>
                            );
                         })}
                      </div>
                   </div>
                </div>
             </div>
          );
       }

       // --- REVIEW ---
       const results = getResults();
       const categoryColors = { "BDG": "from-orange-400 to-red-500", "SPG": "from-blue-400 to-indigo-500", "StPO": "from-pink-400 to-rose-500", "StGB": "from-purple-500 to-violet-700", "Verkehr": "from-amber-400 to-orange-500", "Verfassung": "from-cyan-400 to-blue-600", "Verwaltung": "from-emerald-400 to-teal-500" };

       return (
          <div className="min-h-screen bg-bg-light dark:bg-bg-dark p-6 pb-32 animate-fade-in">
             <div className="max-w-xl mx-auto space-y-8 pt-8">
                {/* Result Header */}
                <div className="text-center space-y-4">
                   <div className={`w-24 h-24 rounded-[2rem] mx-auto flex items-center justify-center shadow-xl ${results.passed ? 'bg-gradient-to-br from-success to-emerald-600' : 'bg-gradient-to-br from-danger to-red-700'}`}>
                      {results.passed ? <Icons.Check className="w-12 h-12 text-white" /> : <Icons.X className="w-12 h-12 text-white" />}
                   </div>
                   <div>
                      <h2 className="text-3xl font-black dark:text-white">{results.grade}</h2>
                      <p className="text-slate-500 mt-1">{results.totalPoints} / {results.maxPoints} Punkte ({results.percentage}%)</p>
                   </div>
                </div>

                {/* Category Breakdown */}
                <div className="space-y-3">
                   <h3 className="font-bold text-lg dark:text-white">Ergebnis pro Fachbereich</h3>
                   {EXAM_CATEGORIES.map(cat => {
                      const catData = results.perCategory[cat];
                      const catPct = catData.max > 0 ? Math.round((catData.points / catData.max) * 100) : 0;
                      return (
                         <div key={cat} className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark">
                            <div className="flex items-center gap-3">
                               <div className={`w-10 h-10 rounded-xl flex-shrink-0 flex items-center justify-center text-white font-bold text-sm shadow-md bg-gradient-to-br ${categoryColors[cat] || 'from-slate-400 to-slate-600'}`}>
                                  {cat.charAt(0)}
                               </div>
                               <div className="flex-1">
                                  <div className="flex justify-between items-center">
                                     <span className="font-bold text-sm dark:text-slate-200">{cat}</span>
                                     <span className={`text-xs font-black px-2 py-0.5 rounded-full ${catPct >= 50 ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>
                                        {catData.points}/{catData.max} ({catPct}%)
                                     </span>
                                  </div>
                                  <div className="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden">
                                     <div className={`h-full rounded-full transition-all duration-500 ${catPct >= 50 ? 'bg-success' : 'bg-danger'}`} style={{width: `${Math.max(2, catPct)}%`}}></div>
                                  </div>
                               </div>
                            </div>
                         </div>
                      );
                   })}
                </div>

                {/* Detailed Question Review */}
                <div className="space-y-3">
                   <h3 className="font-bold text-lg dark:text-white">Detailauswertung</h3>
                   {results.details.map((d, i) => (
                      <div key={i} className={`p-4 rounded-2xl border ${d.points >= 4 ? 'bg-success/5 border-success/20' : d.points >= 2 ? 'bg-warning/5 border-warning/20' : 'bg-danger/5 border-danger/20'}`}>
                         <div className="flex items-start gap-3">
                            <div className={`w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center text-xs font-bold text-white ${d.points >= 4 ? 'bg-success' : d.points >= 2 ? 'bg-warning' : 'bg-danger'}`}>
                               {d.points}/5
                            </div>
                            <div className="flex-1 min-w-0">
                               <div className="flex items-center gap-2 mb-1">
                                  <span className="text-[10px] font-bold text-primary bg-primary/10 px-1.5 py-0.5 rounded">{d.cat}</span>
                                  <span className="text-[10px] text-slate-400">Frage {i+1}</span>
                               </div>
                               <p className="font-medium text-sm text-slate-800 dark:text-slate-200 leading-relaxed">{d.q.question}</p>
                               <div className="mt-2 space-y-1.5">
                                  {(d.q.choices || []).map((c, ci) => {
                                     const isCorrectChoice = (d.q.correct || []).includes(ci);
                                     const userMark = (d.marks || {})[ci] || null;
                                     let pointResult = 0;
                                     if(userMark === 'true') pointResult = isCorrectChoice ? 1 : -1;
                                     else if(userMark === 'false') pointResult = isCorrectChoice ? -1 : 1;

                                     const bgColor = pointResult === 1 ? 'bg-success/10 border-success/20' : pointResult === -1 ? 'bg-danger/10 border-danger/20' : 'bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700';
                                     return (
                                        <div key={ci} className={`text-xs px-2.5 py-1.5 rounded-lg border flex items-center gap-2 ${bgColor}`}>
                                           <span className={`font-mono font-bold w-5 text-center ${pointResult === 1 ? 'text-success' : pointResult === -1 ? 'text-danger' : 'text-slate-300'}`}>
                                              {pointResult === 1 ? '+1' : pointResult === -1 ? '-1' : ' 0'}
                                           </span>
                                           <span className="w-px h-3 bg-slate-200 dark:bg-slate-600"></span>
                                           <span className={`font-bold w-10 text-center ${isCorrectChoice ? 'text-success' : 'text-danger'}`}>
                                              {isCorrectChoice ? 'Wahr' : 'Falsch'}
                                           </span>
                                           <span className="w-px h-3 bg-slate-200 dark:bg-slate-600"></span>
                                           <span className="text-slate-400 italic w-14 text-center">
                                              {userMark === 'true' ? '→ R' : userMark === 'false' ? '→ F' : '→ –'}
                                           </span>
                                           <span className="w-px h-3 bg-slate-200 dark:bg-slate-600"></span>
                                           <span className="text-slate-600 dark:text-slate-300 flex-1">{c}</span>
                                        </div>
                                     );
                                  })}
                               </div>
                               {d.q.explain && <p className="text-xs text-slate-500 mt-2 italic">{d.q.explain}</p>}
                               {d.q.law_ref && <p className="text-[10px] font-mono text-slate-400 mt-1">{d.q.law_ref}</p>}
                            </div>
                         </div>
                      </div>
                   ))}
                </div>

                <Button size="lg" fullWidth onClick={onExit} className="shadow-xl">Zurück zur Übersicht</Button>
             </div>
          </div>
       );
    };

    const Dashboard = ({ userData, questions, onStartTrain, onStartExam, onStartRealExam, dailyStreak }) => {
       const tiers = userData.tiers || {};
       const tierValues = Object.values(tiers);
       
       const total = questions.length || 1;
       const mastered = tierValues.filter(t => t >= 4).length;
       const working = tierValues.filter(t => t > 1 && t < 4).length;
       const newItems = Math.max(0, total - mastered - working);
       
       const progress = Math.round((mastered / total) * 100);

       const categories = [
          { name: "BDG", color: "from-orange-400 to-red-500" },
          { name: "SPG", color: "from-blue-400 to-indigo-500" },
          { name: "StPO", color: "from-pink-400 to-rose-500" },
          { name: "StGB", color: "from-purple-500 to-violet-700" },
          { name: "Verkehr", color: "from-amber-400 to-orange-500" },
          { name: "Verfassung", color: "from-cyan-400 to-blue-600" },
          { name: "Verwaltung", color: "from-emerald-400 to-teal-500" }
       ];

       const getCategoryStats = (catName) => {
          const catQuestions = questions.filter(q => q.tags?.some(t => t.toLowerCase() === catName.toLowerCase()));
          const countTotal = catQuestions.length;
          if (countTotal === 0) return { mastered: 0, working: 0, new: 0, progress: 0 };
          
          const countMastered = catQuestions.filter(q => (tiers[q.id] || 1) >= 4).length;
          const countWorking = catQuestions.filter(q => (tiers[q.id] || 1) > 1 && (tiers[q.id] || 1) < 4).length;
          const countNew = Math.max(0, countTotal - countMastered - countWorking);
          
          return {
             mastered: countMastered,
             working: countWorking,
             new: countNew,
             progress: Math.round((countMastered / countTotal) * 100)
          };
       };
       
       return (
         <div className="px-6 py-8 space-y-8 pb-32 animate-fade-in">
            {/* Header */}
            <div className="flex justify-between items-center">
               <h2 className="text-3xl font-black text-slate-800 dark:text-white tracking-tight">Übersicht</h2>
            </div>

            {/* Quick Stats Row */}
            <div className="flex gap-4">
               <div className="flex-1 bg-surface-light dark:bg-surface-dark p-3 rounded-2xl border border-border-light dark:border-border-dark flex items-center gap-3">
                  <div className="p-2 bg-accent/10 rounded-xl text-accent"><Icons.Flame className="w-5 h-5"/></div>
                  <div>
                     <div className="text-xs font-bold text-slate-400 uppercase">Streak</div>
                     <div className="font-black text-slate-800 dark:text-white">{dailyStreak} <span className="text-xs font-medium text-slate-400">Tage</span></div>
                  </div>
               </div>
               <div className="flex-1 bg-surface-light dark:bg-surface-dark p-3 rounded-2xl border border-border-light dark:border-border-dark flex items-center gap-3">
                  <div className="p-2 bg-primary/10 rounded-xl text-primary"><Icons.Award className="w-5 h-5"/></div>
                  <div>
                     <div className="text-xs font-bold text-slate-400 uppercase">XP</div>
                     <div className="font-black text-slate-800 dark:text-white">{userData.score}</div>
                  </div>
               </div>
            </div>

            {/* Lernstatus Card */}
            <div className="bg-slate-900 dark:bg-slate-950 p-6 rounded-[2rem] border border-slate-800 shadow-2xl relative overflow-hidden">
               <div className="relative z-10">
                  <h3 className="text-white font-bold text-lg mb-4">Dein Lernstatus</h3>
                  
                  <div className="h-4 bg-slate-800 rounded-full overflow-hidden mb-6 border border-slate-700">
                     <div className="h-full bg-warning transition-all duration-1000 shadow-[0_0_10px_rgba(245,158,11,0.5)]" style={{width: `${Math.max(5, progress)}%`}}></div>
                  </div>

                  <div className="grid grid-cols-3 gap-3">
                     <button onClick={() => onStartTrain({status:'new'})} className="bg-danger/10 border border-danger/20 rounded-xl p-3 text-center transition-transform active:scale-95 hover:bg-danger/20">
                        <div className="text-2xl font-black text-danger">{newItems}</div>
                        <div className="text-[10px] font-bold text-danger/80 uppercase">Neu / Offen</div>
                     </button>
                     <button onClick={() => onStartTrain({status:'wip'})} className="bg-warning/10 border border-warning/20 rounded-xl p-3 text-center transition-transform active:scale-95 hover:bg-warning/20">
                        <div className="text-2xl font-black text-warning">{working}</div>
                        <div className="text-[10px] font-bold text-warning/80 uppercase">In Arbeit</div>
                     </button>
                     <button onClick={() => onStartTrain({status:'mastered'})} className="bg-success/10 border border-success/20 rounded-xl p-3 text-center transition-transform active:scale-95 hover:bg-success/20">
                        <div className="text-2xl font-black text-success">{mastered}</div>
                        <div className="text-[10px] font-bold text-success/80 uppercase">Gemeistert</div>
                     </button>
                  </div>
                  
                  <div className="mt-4 text-center text-xs text-slate-500 font-medium">
                     "Gemeistert" bedeutet: Eine Frage wurde 3x in Folge richtig beantwortet.
                  </div>
               </div>
            </div>

            <Button size="lg" fullWidth onClick={() => onStartTrain(null)} className="shadow-primary/40 py-5 text-lg">JETZT LERNEN</Button>

            <div className="flex gap-3">
               <Button size="lg" onClick={onStartExam} variant="outline" className="py-4 border-warning text-warning hover:bg-warning/10 flex-1">
                  <Icons.Target className="w-5 h-5" /> Üben
               </Button>
               <Button size="lg" onClick={onStartRealExam} variant="outline" className="py-4 border-danger text-danger hover:bg-danger/10 flex-1">
                  <Icons.Clipboard className="w-5 h-5" /> Prüfung
               </Button>
            </div>

            {/* Categories */}
            <div className="space-y-4">
               <h3 className="font-bold text-lg text-slate-800 dark:text-white">Kategorien</h3>
               <div className="grid gap-3">
                  {categories.map((cat) => {
                     const stats = getCategoryStats(cat.name);
                     return (
                        <button key={cat.name} onClick={() => onStartTrain(cat.name)} className="group bg-surface-light dark:bg-surface-dark p-4 rounded-[1.5rem] border border-border-light dark:border-border-dark flex flex-col gap-3 transition-all hover:border-primary active:scale-98 text-left shadow-sm">
                           <div className="flex items-center gap-4 w-full">
                              <div className={`w-10 h-10 rounded-xl flex-shrink-0 flex items-center justify-center text-white font-bold text-sm shadow-md bg-gradient-to-br ${cat.color}`}>
                                 {cat.name.charAt(0)}
                              </div>
                              <div className="flex-1">
                                 <div className="flex justify-between items-center">
                                    <div className="font-bold text-slate-700 dark:text-slate-200">{cat.name}</div>
                                    <div className="text-[10px] font-black text-primary dark:text-primary-light bg-primary/10 px-2 py-0.5 rounded-full">{stats.progress}%</div>
                                 </div>
                              </div>
                              <Icons.ArrowRight className="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 transition-all group-hover:translate-x-1" />
                           </div>
                           
                           {/* Sub-stats for category */}
                           <div className="grid grid-cols-3 gap-2 w-full pt-1">
                              <div className="flex items-center gap-1.5 px-2 py-1 bg-danger/5 dark:bg-danger/10 border border-danger/10 rounded-lg">
                                 <div className="w-1.5 h-1.5 rounded-full bg-danger"></div>
                                 <span className="text-[10px] font-bold text-danger/80">{stats.new} neu</span>
                              </div>
                              <div className="flex items-center gap-1.5 px-2 py-1 bg-warning/5 dark:bg-warning/10 border border-warning/10 rounded-lg">
                                 <div className="w-1.5 h-1.5 rounded-full bg-warning"></div>
                                 <span className="text-[10px] font-bold text-warning/80">{stats.working} wip</span>
                              </div>
                              <div className="flex items-center gap-1.5 px-2 py-1 bg-success/5 dark:bg-success/10 border border-success/10 rounded-lg">
                                 <div className="w-1.5 h-1.5 rounded-full bg-success"></div>
                                 <span className="text-[10px] font-bold text-success/80">{stats.mastered} ok</span>
                              </div>
                           </div>
                        </button>
                     );
                  })}
               </div>
            </div>
         </div>
       );
    };

    // --- Stats Screen ---
    const StatsScreen = ({ history, streakData, currentStreak, longestStreak, activeDays, userData, questions }) => {
       const last7 = useMemo(() => {
          const result = [];
          for(let i = 6; i >= 0; i--) {
             const d = new Date();
             d.setDate(d.getDate() - i);
             const key = d.toISOString().slice(0, 10);
             const entry = (history || []).find(e => e.date === key);
             const dayLabel = d.toLocaleDateString('de-DE', { weekday: 'short' });
             const tp = entry?.totalPoints || entry?.correct || 0;
             const mp = entry?.totalMaxPoints || (entry?.questionsAnswered ? entry.questionsAnswered * 5 : 0);
             const avgPts = entry?.questionsAnswered > 0 ? (tp / entry.questionsAnswered).toFixed(1) : null;
             result.push({ date: key, dayLabel, questionsAnswered: entry?.questionsAnswered || 0, totalPoints: tp, totalMaxPoints: mp, avgPoints: avgPts });
          }
          return result;
       }, [history]);

       const maxQuestions = Math.max(...last7.map(d => d.questionsAnswered), 1);
       const totalAnswered = (history || []).reduce((s, e) => s + e.questionsAnswered, 0);
       const totalPoints = (history || []).reduce((s, e) => s + (e.totalPoints || e.correct || 0), 0);
       const totalMaxPoints = (history || []).reduce((s, e) => s + (e.totalMaxPoints || (e.questionsAnswered ? e.questionsAnswered * 5 : 0)), 0);
       const overallAvg = totalAnswered > 0 ? (totalPoints / totalAnswered).toFixed(1) : '0.0';
       const overallPct = totalMaxPoints > 0 ? Math.round((totalPoints / totalMaxPoints) * 100) : 0;

       // Streak calendar (last 28 days)
       const last28 = useMemo(() => {
          const result = [];
          for(let i = 27; i >= 0; i--) {
             const d = new Date();
             d.setDate(d.getDate() - i);
             const key = d.toISOString().slice(0, 10);
             result.push({ date: key, active: (activeDays || []).includes(key), dayNum: d.getDate() });
          }
          return result;
       }, [activeDays]);

       const tiers = userData.tiers || {};
       const tierValues = Object.values(tiers);
       const total = questions.length || 1;
       const mastered = tierValues.filter(t => t >= 4).length;

       return (
          <div className="px-6 py-8 space-y-8 pb-32 animate-fade-in">
             <h2 className="text-3xl font-black text-slate-800 dark:text-white tracking-tight">Statistiken</h2>

             {/* Streak Section */}
             <div className="bg-gradient-to-br from-accent/10 to-primary/10 p-6 rounded-[2rem] border border-accent/20 space-y-4">
                <div className="flex items-center justify-between">
                   <div className="flex items-center gap-3">
                      <div className="p-2 bg-accent/20 rounded-xl text-accent"><Icons.Flame className="w-6 h-6"/></div>
                      <div>
                         <div className="text-xs font-bold text-slate-400 uppercase">Täglicher Streak</div>
                         <div className="text-3xl font-black text-slate-800 dark:text-white">{currentStreak} <span className="text-base font-medium text-slate-400">Tage</span></div>
                      </div>
                   </div>
                   <div className="text-right">
                      <div className="text-[10px] font-bold text-slate-400 uppercase">Rekord</div>
                      <div className="text-lg font-black text-accent">{longestStreak} Tage</div>
                   </div>
                </div>

                {/* Mini Calendar */}
                <div className="grid grid-cols-7 gap-1.5">
                   {last28.map((d, i) => (
                      <div key={i} className={`aspect-square rounded-lg flex items-center justify-center text-[10px] font-bold transition-all ${d.active ? 'bg-accent text-white shadow-sm shadow-accent/30' : d.date === todayKey() ? 'bg-slate-200 dark:bg-slate-700 text-slate-500 ring-2 ring-accent/50' : 'bg-slate-100 dark:bg-slate-800/50 text-slate-400'}`}>
                         {d.dayNum}
                      </div>
                   ))}
                </div>
             </div>

             {/* Weekly Chart with avg points */}
             <div className="bg-surface-light dark:bg-surface-dark p-6 rounded-[2rem] border border-border-light dark:border-border-dark space-y-4">
                <div className="flex items-center gap-2">
                   <Icons.BarChart className="w-5 h-5 text-primary" />
                   <h3 className="font-bold dark:text-white">Letzte 7 Tage</h3>
                </div>
                <div className="flex items-end gap-2 h-36">
                   {last7.map((d, i) => (
                      <div key={i} className="flex-1 flex flex-col items-center gap-1">
                         <div className="w-full flex flex-col items-center justify-end h-28">
                            {d.avgPoints !== null && <span className={`text-[10px] font-black mb-0.5 ${parseFloat(d.avgPoints) >= 4 ? 'text-success' : parseFloat(d.avgPoints) >= 2 ? 'text-warning' : 'text-danger'}`}>{d.avgPoints}</span>}
                            {d.questionsAnswered > 0 && <span className="text-[9px] text-slate-400 mb-0.5">{d.questionsAnswered}F</span>}
                            <div className="w-full rounded-t-lg transition-all duration-500" style={{
                               height: `${Math.max(4, (d.questionsAnswered / maxQuestions) * 100)}%`,
                               background: d.questionsAnswered > 0 ? (d.avgPoints !== null && parseFloat(d.avgPoints) >= 3 ? 'linear-gradient(to top, #22C55E, #4ADE80)' : 'linear-gradient(to top, #6366F1, #818CF8)') : '#E2E8F0',
                               minHeight: '4px'
                            }}></div>
                         </div>
                         <span className={`text-[10px] font-bold ${d.date === todayKey() ? 'text-primary' : 'text-slate-400'}`}>{d.dayLabel}</span>
                      </div>
                   ))}
                </div>
                <div className="text-[10px] text-slate-400 text-center">Zahl über Balken = Durchschnittspunkte pro Frage (max. 5)</div>
             </div>

             {/* Summary Cards */}
             <div className="grid grid-cols-2 gap-3">
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark">
                   <div className="flex items-center gap-2 mb-2">
                      <Icons.Target className="w-4 h-4 text-primary" />
                      <span className="text-xs font-bold text-slate-400 uppercase">Durchschnitt</span>
                   </div>
                   <div className="text-2xl font-black text-slate-800 dark:text-white">{overallAvg}<span className="text-sm font-medium text-slate-400">/5</span></div>
                   <div className="text-xs text-slate-400">Punkte pro Frage</div>
                </div>
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark">
                   <div className="flex items-center gap-2 mb-2">
                      <Icons.TrendingUp className="w-4 h-4 text-success" />
                      <span className="text-xs font-bold text-slate-400 uppercase">Punkterate</span>
                   </div>
                   <div className="text-2xl font-black text-slate-800 dark:text-white">{overallPct}%</div>
                   <div className="text-xs text-slate-400">{totalPoints} / {totalMaxPoints} Punkte</div>
                </div>
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark">
                   <div className="flex items-center gap-2 mb-2">
                      <Icons.Award className="w-4 h-4 text-warning" />
                      <span className="text-xs font-bold text-slate-400 uppercase">Gemeistert</span>
                   </div>
                   <div className="text-2xl font-black text-slate-800 dark:text-white">{mastered}/{total}</div>
                </div>
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark">
                   <div className="flex items-center gap-2 mb-2">
                      <Icons.Calendar className="w-4 h-4 text-accent" />
                      <span className="text-xs font-bold text-slate-400 uppercase">Lerntage</span>
                   </div>
                   <div className="text-2xl font-black text-slate-800 dark:text-white">{(activeDays || []).length}</div>
                </div>
             </div>

             {/* Recent Sessions */}
             {(history || []).length > 0 && (
                <div className="space-y-3">
                   <h3 className="font-bold text-lg dark:text-white">Verlauf</h3>
                   {[...(history || [])].reverse().slice(0, 14).map((entry, i) => {
                      const tp = entry.totalPoints || entry.correct || 0;
                      const mp = entry.totalMaxPoints || (entry.questionsAnswered ? entry.questionsAnswered * 5 : 0);
                      const avg = entry.questionsAnswered > 0 ? (tp / entry.questionsAnswered).toFixed(1) : '0.0';
                      const pct = mp > 0 ? Math.round((tp / mp) * 100) : 0;
                      const dateObj = new Date(entry.date + 'T00:00:00');
                      const dateStr = dateObj.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' });
                      return (
                         <div key={i} className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark flex items-center gap-4">
                            <div className={`w-12 h-12 rounded-xl flex flex-col items-center justify-center text-white ${pct >= 80 ? 'bg-success' : pct >= 50 ? 'bg-warning' : 'bg-danger'}`}>
                               <span className="text-sm font-black leading-none">{avg}</span>
                               <span className="text-[8px] opacity-80">/5</span>
                            </div>
                            <div className="flex-1">
                               <div className="font-bold text-sm dark:text-white">{dateStr}</div>
                               <div className="text-xs text-slate-400">{entry.questionsAnswered} Fragen · {entry.sessions} Sitzung{entry.sessions > 1 ? 'en' : ''}</div>
                            </div>
                            <div className="text-right">
                               <div className="text-sm font-bold text-primary">{tp}<span className="text-slate-400 font-normal">/{mp}</span></div>
                               <div className="text-[10px] text-slate-400">Punkte</div>
                            </div>
                         </div>
                      );
                   })}
                </div>
             )}
          </div>
       );
    };

    /* ================= APP SHELL ================= */
    const App = () => {
       const userManager = useUsers();
       const [activeUser, setActiveUser] = useUserLocalStorage("app", "activeUser", null);
       const [view, setView] = useState("dashboard");
       const [darkMode, setDarkMode] = useState(() => localStorage.getItem("theme") !== "light"); // Default Dark
       const [trainFilter, setTrainFilter] = useState(null);
       const { questions, save, remove, status: qStatus } = useQuestions();
       const [userData, setUserData, pStatus] = useUserLocalStorage(activeUser?.id, "progress", { tiers: {}, score: 0, streak: 0 });

       // Daily Streak & Learning History hooks
       const { streakData, currentStreak, longestStreak, recordActivity, activeDays } = useDailyStreak(activeUser?.id);
       const { history, recordSession } = useLearningHistory(activeUser?.id);

       useEffect(() => { if(darkMode) document.documentElement.classList.add("dark"); else document.documentElement.classList.remove("dark"); localStorage.setItem("theme", darkMode ? "dark" : "light"); }, [darkMode]);

       // Wrap training exit to record stats
       const handleTrainExit = useCallback((totalPoints, totalMaxPoints, questionsAnswered) => {
          const count = questionsAnswered || 0;
          if(count > 0) {
             recordSession(count, totalPoints || 0, totalMaxPoints || 0);
             recordActivity();
          }
          setView('dashboard');
       }, [recordSession, recordActivity]);

       const startTraining = (filter) => { setTrainFilter(filter); setView('train'); };
       const startExam = () => setView('exam');
       const startRealExam = () => setView('realexam');

       if(!activeUser) return <ErrorBoundary><AuthScreen userManager={userManager} onLogin={setActiveUser} /></ErrorBoundary>;
       if(view === 'train') return <ErrorBoundary><TrainingMode questions={questions} userData={userData} setUserData={setUserData} onExit={handleTrainExit} filterTag={trainFilter} /></ErrorBoundary>;
       if(view === 'exam') return <ErrorBoundary><ExamMode questions={questions} userData={userData} setUserData={setUserData} onExit={()=>setView('dashboard')} /></ErrorBoundary>;
       if(view === 'realexam') return <ErrorBoundary><RealExamMode questions={questions} onExit={()=>setView('dashboard')} /></ErrorBoundary>;

       const NavItem = ({ id, icon: Icon, label }) => (
         <button onClick={()=>setView(id)} className={`relative p-3 rounded-2xl transition-all duration-300 flex flex-col items-center gap-1 ${view===id ? 'text-primary' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}>
            <Icon className={`w-6 h-6 transition-transform ${view===id ? '-translate-y-1' : ''}`} strokeWidth={view===id ? 2.5 : 2} />
            {view===id && <span className="absolute -bottom-1 w-1 h-1 rounded-full bg-current"></span>}
         </button>
       );

       return (
         <ErrorBoundary>
           <div className="min-h-screen flex flex-col">
             <header className="px-6 pt-12 pb-2 flex justify-between items-center">
                <div className="flex items-center gap-3">
                   <div className="w-10 h-10 rounded-2xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center font-black text-slate-600 dark:text-slate-300 text-lg border-2 border-white dark:border-slate-600 shadow-sm">{activeUser.username.charAt(0)}</div>
                   <div className="flex flex-col">
                      <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hallo</span>
                      <span className="text-sm font-bold dark:text-white">{activeUser.username}</span>
                   </div>
                </div>
                <div className="flex gap-3">
                   <div className="flex items-center justify-center w-10 h-10 bg-surface-light dark:bg-surface-dark rounded-full border border-border-light dark:border-border-dark shadow-sm"><SyncStatus status={pStatus}/></div>
                   <button onClick={()=>setDarkMode(!darkMode)} className="w-10 h-10 flex items-center justify-center bg-surface-light dark:bg-surface-dark rounded-full border border-border-light dark:border-border-dark shadow-sm text-slate-500 hover:text-primary transition-colors">{darkMode ? <Icons.Sun className="w-5 h-5"/> : <Icons.Moon className="w-5 h-5"/>}</button>
                </div>
             </header>

             <main className="flex-1 max-w-lg mx-auto w-full">
                {view === 'dashboard' && <Dashboard userData={userData} questions={questions} onStartTrain={startTraining} onStartExam={startExam} onStartRealExam={startRealExam} dailyStreak={currentStreak} />}
                {view === 'stats' && <StatsScreen history={history} streakData={streakData} currentStreak={currentStreak} longestStreak={longestStreak} activeDays={activeDays} userData={userData} questions={questions} />}
                {view === 'admin' && <AdminPanel questions={questions} qManager={{save, remove}} />}
                {view === 'profile' && <ProfileScreen user={activeUser} userManager={userManager} onLogout={()=>setActiveUser(null)} />}
             </main>

             <div className="fixed bottom-6 left-0 w-full flex justify-center z-50 px-4 safe-pb">
                <nav className="glass bg-white/80 dark:bg-slate-900/80 px-6 py-2 rounded-full shadow-2xl border border-white/20 dark:border-slate-700/50 flex items-center gap-6 backdrop-blur-xl">
                   <NavItem id="dashboard" icon={Icons.Home} />
                   <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                   <NavItem id="stats" icon={Icons.BarChart} />
                   <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                   <NavItem id="admin" icon={Icons.Book} />
                   <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                   <NavItem id="profile" icon={Icons.User} />
                </nav>
             </div>
           </div>
         </ErrorBoundary>
       );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
