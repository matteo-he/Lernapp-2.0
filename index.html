
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Lerntool E1 / E2a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
          colors: {
            // Deep Space Theme
            bg: { light: '#F8FAFC', dark: '#0F172A' },
            surface: { light: '#FFFFFF', dark: '#1E293B' },
            border: { light: '#E2E8F0', dark: '#334155' },
            primary: { DEFAULT: '#6366F1', dark: '#4338CA', light: '#EEF2FF' },
            accent:  { DEFAULT: '#F472B6', dark: '#DB2777' }, // Pink for streaks
            success: { DEFAULT: '#22C55E', dark: '#15803D', light: '#DCFCE7' },
            danger:  { DEFAULT: '#EF4444', dark: '#B91C1C', light: '#FEE2E2' },
            warning: { DEFAULT: '#F59E0B', dark: '#D97706', light: '#FEF3C7' },
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out',
            'slide-up': 'slideUp 0.5s cubic-bezier(0.19, 1, 0.22, 1)',
            'scale-in': 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
            'pulse-slow': 'pulse 3s infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
          }
        }
      }
    };
  </script>
  <style>
    /* Custom Scrollbar for sleek look */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    
    /* Tactile Button logic */
    .btn-tactile {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .btn-tactile:active {
      transform: scale(0.96);
    }
    
    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .dark .glass {
      background: rgba(30, 41, 59, 0.7);
    }

    .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="module">
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, doc, writeBatch, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLH5c69JKeFWcJyBpzRUfv720KjnnRIU8",
      authDomain: "e1-und-e2a-lerntool.firebaseapp.com",
      projectId: "e1-und-e2a-lerntool",
      storageBucket: "e1-und-e2a-lerntool.firebasestorage.app",
      messagingSenderId: "28649721297",
      appId: "1:28649721297:web:432abbe98e34dd50fc24f0"
    };

    function ensureApp(){ return getApps().length ? getApp() : initializeApp(firebaseConfig); }
    const app = ensureApp();
    const db = getFirestore(app);
    const auth = getAuth(app);
    let authPromise = new Promise((resolve) => {
      const unsub = onAuthStateChanged(auth, (user) => {
        if(user) { resolve(user); unsub(); }
        else { signInAnonymously(auth).catch(()=>{}); }
      });
    });
    
    window.FIREBASE_BRIDGE = {
      ensureApp, getFirestore, collection, doc, writeBatch, onSnapshot, setDoc,
      ensureAuthUser: () => authPromise,
      auth
    };
    window.__FIREBASE_BRIDGE_READY__ = true;
    window.dispatchEvent(new Event('firebase-bridge-ready'));
  </script>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-slate-800 dark:text-slate-100 select-none font-sans antialiased selection:bg-primary selection:text-white">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    /* ================= ICONS ================= */
    const Icons = {
      Check: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12" /></svg>,
      X: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>,
      Home: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
      Book: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
      Settings: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
      User: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
      Flame: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3a9 9 0 0 0 2.5 2.8z"></path></svg>,
      CloudCheck: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><polyline points="8 15 11 18 16 11"></polyline></svg>,
      Award: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>,
      ArrowRight: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
      Upload: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
      Trash: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
      Edit: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
      Moon: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
      Sun: (props) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
    };

    /* ================= UTILS & LOGIC ================= */
    const clone = (o) => JSON.parse(JSON.stringify(o));
    const generateId = (p="id") => `${p}-${Math.random().toString(36).slice(2,8)}`;
    const hashPassword = (s) => `h${s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a|0},0)}`;
    
    function xmur3(str){ let h = 1779033703 ^ str.length; for(let i=0;i<str.length;i++){ h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h << 13 | h >>> 19; } return function(){ h = Math.imul(h ^ h >>> 16, 2246822507); h = Math.imul(h ^ h >>> 13, 3266489909); return (h ^ h >>> 16) >>> 0; }; }
    function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
    function weightedOrder(items, tierResolver, seedStr){ const seed = xmur3(seedStr)(); const rng = mulberry32(seed); return [...items].map(x => ({ x, k: (rng() || Number.EPSILON) ** (1 / ({1:5,2:3,3:2,4:1.2,5:1}[tierResolver(x.id)]||1)) })).sort((a,b) => b.k - a.k).map(o => o.x); }

    /* ================= HOOKS ================= */
    function useUserLocalStorage(userId, key, initial){
      const storageKey = userId ? `${userId}:${key}` : null;
      const [state, setState] = useState(() => { try { return storageKey ? (JSON.parse(localStorage.getItem(storageKey)) || initial) : initial; } catch { return initial; } });
      const [status, setStatus] = useState("local"); 

      useEffect(() => { if(!userId) return; localStorage.setItem(storageKey, JSON.stringify(state)); }, [state, storageKey, userId]);
      useEffect(() => {
         if(!userId || !window.FIREBASE_BRIDGE) return;
         let unsub = () => {}; const { onSnapshot, doc, getFirestore, ensureApp, setDoc } = window.FIREBASE_BRIDGE; const db = getFirestore(ensureApp());
         const sync = async () => { try { setStatus("syncing"); unsub = onSnapshot(doc(db, "userProgress", userId), (snap) => { if(snap.exists()) { const data = snap.data(); if(data[key]) { setState(prev => JSON.stringify(prev) !== JSON.stringify(data[key]) ? data[key] : prev); setStatus("synced"); } } else { setDoc(doc(db, "userProgress", userId), { [key]: state }, { merge: true }); setStatus("synced"); } }, (err) => { setStatus("error"); }); } catch(e) { setStatus("error"); } };
         sync(); return () => unsub();
      }, [userId, key]);
      useEffect(() => {
         if(status === 'error' || !userId || !window.FIREBASE_BRIDGE) return;
         const timeout = setTimeout(() => { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; setDoc(doc(getFirestore(ensureApp()), "userProgress", userId), { [key]: state }, { merge: true }).then(() => setStatus("synced")).catch(() => setStatus("error")); }, 1000);
         return () => clearTimeout(timeout);
      }, [state, userId, key]);
      return [state, setState, status];
    }

    function useUsers() {
       const [users, setUsers] = useState(() => { try { return JSON.parse(localStorage.getItem("users") || "[]").filter(Boolean); } catch { return []; } });
       useEffect(() => { localStorage.setItem("users", JSON.stringify(users)); }, [users]);
       useEffect(() => {
          if(!window.FIREBASE_BRIDGE) return; const { onSnapshot, collection, getFirestore, ensureApp } = window.FIREBASE_BRIDGE;
          const unsub = onSnapshot(collection(getFirestore(ensureApp()), "users"), (snap) => { const remotes = snap.docs.map(d => d.data()); setUsers(prev => { const map = new Map(prev.map(u => [u.id, u])); remotes.forEach(u => map.set(u.id, u)); return Array.from(map.values()); }); }, (err) => {});
          return () => unsub();
       }, []);
       const login = (name, pwd) => { const hash = hashPassword(pwd); const u = users.find(u => u.username.toLowerCase() === name.toLowerCase() && u.passwordHash === hash); if(u) return { success: true, user: u }; return { success: false, error: "Ungültige Zugangsdaten" }; };
       const register = (name, pwd, code) => { if(users.some(u => u.username.toLowerCase() === name.toLowerCase())) return { success: false, error: "Nutzername vergeben" }; const role = (code === "POLIZEI-ADMIN") ? "admin" : "user"; const newUser = { id: generateId("u"), username: name, passwordHash: hashPassword(pwd), role }; setUsers(prev => [...prev, newUser]); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; setDoc(doc(getFirestore(ensureApp()), "users", newUser.id), newUser); } return { success: true, user: newUser }; };
       const updatePassword = (uid, newPwd) => { const hash = hashPassword(newPwd); setUsers(prev => prev.map(u => u.id === uid ? { ...u, passwordHash: hash } : u)); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; setDoc(doc(getFirestore(ensureApp()), "users", uid), { passwordHash: hash }, { merge: true }); } };
       return { users, login, register, updatePassword };
    }

    function useQuestions() {
       const [questions, setQuestions] = useState([]);
       const [status, setStatus] = useState("loading");
       useEffect(() => {
          const defaults = [ { id: "q1", question: "§ 43 BDG: Wie hat ein Beamter seine dienstlichen Aufgaben zu erfüllen?", choices: ["Unter Beachtung der Rechtsordnung", "Treu und gewissenhaft", "Nach eigenem Ermessen", "Nur auf Weisung", "Schnellstmöglich"], correct: [0, 1], explain: "Rechtstreue und Gewissenhaftigkeit sind Kernpflichten.", law_ref: "BDG § 43", tags: ["BDG"], difficulty: 1 }, { id: "q2", question: "Was ist bei einer Dienstzuteilung (§ 39 BDG) über 90 Tage erforderlich?", choices: ["Zustimmung des Beamten", "Schriftliche Weisung", "Keine Zustimmung nötig", "Personalvertretung muss zustimmen", "Darf nicht erfolgen"], correct: [0], explain: "Über 90 Tage ist die Zustimmung erforderlich, außer bei Ausbildung.", law_ref: "BDG § 39", tags: ["BDG"], difficulty: 2 }, ];
          if(!window.FIREBASE_BRIDGE) { setQuestions(defaults); return; }
          const { onSnapshot, collection, getFirestore, ensureApp } = window.FIREBASE_BRIDGE;
          const unsub = onSnapshot(collection(getFirestore(ensureApp()), "questions"), (snap) => { const list = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(q => !q.__deleted); if(list.length === 0) setQuestions(defaults); else setQuestions(list); setStatus("ready"); }, (err) => { setQuestions(defaults); setStatus("error"); });
          return () => unsub();
       }, []);
       const save = async (q) => { setQuestions(prev => { const idx = prev.findIndex(item => item.id === q.id); if(idx >= 0) { const n = [...prev]; n[idx] = q; return n; } return [...prev, q]; }); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; await setDoc(doc(getFirestore(ensureApp()), "questions", q.id), q); } };
       const remove = async (id) => { setQuestions(prev => prev.filter(q => q.id !== id)); if(window.FIREBASE_BRIDGE) { const { setDoc, doc, getFirestore, ensureApp } = window.FIREBASE_BRIDGE; await setDoc(doc(getFirestore(ensureApp()), "questions", id), { __deleted: true }, { merge: true }); } };
       return { questions, status, save, remove };
    }

    /* ================= UI COMPONENTS ================= */
    const Button = ({ children, onClick, variant='primary', size='md', fullWidth=false, className='', disabled=false }) => {
       const base = "font-bold rounded-2xl btn-tactile disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2 tracking-wide";
       const variants = {
          primary: "bg-primary dark:bg-primary-dark text-white shadow-lg shadow-primary/20 hover:brightness-110",
          success: "bg-success dark:bg-success-dark text-white shadow-lg shadow-success/20",
          danger: "bg-danger dark:bg-danger-dark text-white shadow-lg shadow-danger/20",
          ghost: "bg-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800",
          outline: "border-2 border-border-light dark:border-border-dark text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/50"
       };
       const sizes = { sm: "px-3 py-1 text-xs", md: "px-5 py-3 text-sm", lg: "px-6 py-4 text-base" };
       return (
          <button className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth?'w-full':''} ${className}`} onClick={onClick} disabled={disabled}>
             {children}
          </button>
       );
    };

    const SegmentedProgress = ({ current, total }) => (
      <div className="flex gap-1.5 w-full h-1.5">
         {Array.from({length: total}).map((_, i) => (
           <div key={i} className={`flex-1 rounded-full transition-all duration-300 ${i < current ? 'bg-primary dark:bg-primary-dark' : i === current ? 'bg-slate-300 dark:bg-slate-600 animate-pulse' : 'bg-slate-200 dark:bg-slate-800'}`} />
         ))}
      </div>
    );

    const SyncStatus = ({ status }) => {
       if(status === 'syncing') return <div className="w-2 h-2 rounded-full bg-accent animate-pulse shadow-[0_0_8px_currentColor]" title="Sync..."></div>;
       if(status === 'error') return <div className="w-2 h-2 rounded-full bg-danger" title="Offline"></div>;
       return <div className="w-2 h-2 rounded-full bg-success shadow-[0_0_8px_currentColor]" title="Synced"></div>;
    };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false }; }
      static getDerivedStateFromError(error) { return { hasError: true }; }
      componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
      render() {
        if (this.state.hasError) return <div className="p-8 text-center text-danger">Ein Fehler ist aufgetreten.<br/><button onClick={()=>window.location.reload()} className="underline mt-2">Neu laden</button></div>;
        return this.props.children;
      }
    }

    /* ================= FEATURE COMPONENTS ================= */
    
    // --- Auth ---
    const AuthScreen = ({ userManager, onLogin }) => {
       const [isRegister, setIsRegister] = useState(false);
       const [name, setName] = useState("");
       const [pwd, setPwd] = useState("");
       const [code, setCode] = useState("");
       const [error, setError] = useState("");

       const handleSubmit = (e) => {
          e.preventDefault();
          setError("");
          try {
             const res = isRegister ? userManager.register(name, pwd, code) : userManager.login(name, pwd);
             if(res.success) onLogin(res.user); else setError(res.error);
          } catch(err) { setError(err.message || String(err)); }
       };

       return (
          <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden bg-bg-light dark:bg-bg-dark">
             {/* Decor */}
             <div className="absolute -top-20 -left-20 w-64 h-64 bg-primary/20 rounded-full blur-3xl"></div>
             <div className="absolute -bottom-20 -right-20 w-80 h-80 bg-accent/20 rounded-full blur-3xl"></div>
             
             <div className="relative glass w-full max-w-sm p-8 rounded-[2rem] border border-white/20 shadow-2xl space-y-8 animate-scale-in">
                <div className="text-center">
                   <h1 className="text-3xl font-black tracking-tighter mb-1 text-slate-800 dark:text-white">Lerntool<span className="text-primary">.</span></h1>
                   <p className="text-slate-500 text-sm font-medium">Dein Begleiter für E1/E2a</p>
                </div>
                
                <div className="flex bg-slate-100 dark:bg-slate-800/50 p-1.5 rounded-2xl">
                   <button onClick={()=>setIsRegister(false)} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${!isRegister ? 'bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>Anmelden</button>
                   <button onClick={()=>setIsRegister(true)} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${isRegister ? 'bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>Registrieren</button>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4">
                   <input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-primary transition-colors font-medium text-slate-800 dark:text-white" placeholder="Benutzername" value={name} onChange={e=>setName(e.target.value)} required />
                   <input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-primary transition-colors font-medium text-slate-800 dark:text-white" type="password" placeholder="Passwort" value={pwd} onChange={e=>setPwd(e.target.value)} required />
                   {isRegister && <input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-primary transition-colors font-medium text-slate-800 dark:text-white" placeholder="Admin Code (Optional)" value={code} onChange={e=>setCode(e.target.value)} />}
                   
                   {error && <div className="text-danger text-sm text-center font-medium bg-danger/10 p-2 rounded-lg">{error}</div>}
                   <Button fullWidth size="lg" className="shadow-primary/30 mt-2">{isRegister ? 'Starten' : 'Los geht\'s'}</Button>
                </form>
             </div>
          </div>
       );
    };

    // --- Profile ---
    const ProfileScreen = ({ user, userManager, onLogout }) => {
       const [pwd, setPwd] = useState("");
       const handlePwd = (e) => { e.preventDefault(); if(pwd.length < 4) return alert("Zu kurz"); userManager.updatePassword(user.id, pwd); alert("Passwort geändert"); setPwd(""); };
       return (
          <div className="p-6 space-y-6 pt-12 animate-fade-in">
             <div className="text-center space-y-2">
                <div className="w-24 h-24 bg-gradient-to-br from-primary to-accent rounded-[2rem] mx-auto flex items-center justify-center text-4xl font-black text-white shadow-xl shadow-primary/30">{user.username.charAt(0)}</div>
                <h2 className="text-2xl font-bold dark:text-white">{user.username}</h2>
                <span className="inline-block px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-xs font-bold uppercase text-slate-500 tracking-wider">{user.role}</span>
             </div>

             <div className="bg-surface-light dark:bg-surface-dark p-6 rounded-3xl border border-border-light dark:border-border-dark shadow-sm">
                <h3 className="font-bold mb-4 flex items-center gap-2 dark:text-white"><Icons.Settings className="w-5 h-5"/> Sicherheit</h3>
                <form onSubmit={handlePwd} className="flex gap-2">
                   <input className="flex-1 px-4 py-2 border border-border-light dark:border-border-dark rounded-xl bg-transparent outline-none focus:border-primary dark:text-white" type="password" placeholder="Neues Passwort" value={pwd} onChange={e=>setPwd(e.target.value)} />
                   <Button size="sm">Update</Button>
                </form>
             </div>
             <Button fullWidth variant="ghost" onClick={onLogout} className="text-danger hover:bg-danger/10">Abmelden</Button>
          </div>
       );
    };

    // --- Admin ---
    const AdminPanel = ({ questions, qManager }) => {
       const [search, setSearch] = useState("");
       const [editQ, setEditQ] = useState(null);
       const fileRef = useRef(null);
       const filtered = questions.filter(q => q.question.toLowerCase().includes(search.toLowerCase()) || q.id.toLowerCase().includes(search.toLowerCase()));

       const handleSave = (e) => {
          e.preventDefault(); const formData = new FormData(e.target);
          const newQ = { id: editQ.id || generateId("q"), question: formData.get("question"), choices: [0,1,2,3,4].map(i => formData.get(`c${i}`)), correct: [0,1,2,3,4].filter(i => formData.get(`chk${i}`)).map(Number), explain: formData.get("explain"), law_ref: formData.get("law"), tags: formData.get("tags").split(",").map(t=>t.trim()).filter(Boolean), difficulty: 1 };
          qManager.save(newQ); setEditQ(null);
       };

       const handleImport = async (e) => {
          const file = e.target.files?.[0]; if(!file) return;
          try { const text = await file.text(); const data = JSON.parse(text); if(!Array.isArray(data)) throw new Error("Array required"); for(const q of data) { if(q.question) { if(!q.id) q.id = generateId("q"); await qManager.save({ id: q.id, question: q.question, choices: q.choices, correct: q.correct||[], explain: q.explain||"", law_ref: q.law_ref||"", tags: q.tags||[], difficulty: q.difficulty||1 }); } } alert("Import success!"); } catch(err) { alert(err.message); } e.target.value = null;
       };

       return (
          <div className="p-6 space-y-6 pt-8 pb-32 animate-fade-in">
             <div className="flex gap-2">
                <input className="flex-1 px-4 py-2 rounded-2xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark outline-none dark:text-white" placeholder="Fragen suchen..." value={search} onChange={e=>setSearch(e.target.value)} />
                <input type="file" ref={fileRef} onChange={handleImport} className="hidden" accept=".json" />
                <Button variant="outline" onClick={()=>fileRef.current.click()}><Icons.Upload className="w-5 h-5"/></Button>
                <Button onClick={()=>setEditQ({id:"", question:"", choices:["","","","",""], correct:[], tags:[], explain:"", law_ref:""})}>Neu</Button>
             </div>

             <div className="grid gap-3">
                {filtered.map(q => (
                   <div key={q.id} className="bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark flex gap-4 group">
                      <div className="flex-1 min-w-0">
                         <div className="font-bold text-sm truncate dark:text-white">{q.question}</div>
                         <div className="text-xs text-slate-400 mt-1 flex gap-2">
                           <span className="bg-slate-100 dark:bg-slate-700 px-1.5 rounded">{q.id}</span>
                           <span>{q.tags.join(", ")}</span>
                         </div>
                      </div>
                      <div className="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                         <button onClick={()=>setEditQ(q)} className="text-primary hover:text-primary-dark"><Icons.Edit className="w-5 h-5"/></button>
                         <button onClick={()=>{if(confirm("Löschen?")) qManager.remove(q.id)}} className="text-danger hover:text-danger-dark"><Icons.Trash className="w-5 h-5"/></button>
                      </div>
                   </div>
                ))}
             </div>

             {editQ && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                   <form onSubmit={handleSave} className="bg-surface-light dark:bg-surface-dark w-full max-w-lg rounded-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto space-y-4 border border-border-light dark:border-border-dark">
                      <h2 className="font-black text-xl dark:text-white">{editQ.id ? 'Bearbeiten' : 'Erstellen'}</h2>
                      <textarea name="question" defaultValue={editQ.question} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl font-medium dark:text-white outline-none focus:border-primary" placeholder="Die Frage..." required rows={3}/>
                      <div className="space-y-2">
                         <label className="text-xs font-bold uppercase text-slate-400">Antworten (Check = Korrekt)</label>
                         {editQ.choices.map((c, i) => (
                            <div key={i} className="flex gap-3 items-center">
                               <input type="checkbox" name={`chk${i}`} defaultChecked={editQ.correct.includes(i)} className="w-5 h-5 accent-success rounded" />
                               <input name={`c${i}`} defaultValue={c} className="flex-1 p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder={`Option ${i+1}`} required />
                            </div>
                         ))}
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                         <input name="tags" defaultValue={editQ.tags.join(", ")} className="p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder="Tags (BDG, SPG)" />
                         <input name="law" defaultValue={editQ.law_ref} className="p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder="§ Gesetz" />
                      </div>
                      <textarea name="explain" defaultValue={editQ.explain} className="w-full p-2 bg-slate-50 dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl text-sm dark:text-white outline-none focus:border-primary" placeholder="Erklärung..." rows={2}/>
                      <div className="flex gap-2 pt-2">
                         <Button type="button" variant="ghost" onClick={()=>setEditQ(null)} fullWidth>Abbruch</Button>
                         <Button type="submit" fullWidth>Speichern</Button>
                      </div>
                   </form>
                </div>
             )}
          </div>
       );
    };

    // --- Training ---
    const TrainingMode = ({ questions, userData, setUserData, onExit, filterTag }) => {
       const [queue, setQueue] = useState([]);
       const [qIndex, setQIndex] = useState(0);
       const [feedbackMode, setFeedbackMode] = useState(false);
       const [isCorrect, setIsCorrect] = useState(false);
       const [lastSelection, setLastSelection] = useState([]);
       const [loading, setLoading] = useState(true);

       useEffect(() => {
          if(!questions || queue.length > 0) return;
          setLoading(true);
          let pool = questions;
          
          // Smart filtering
          if(filterTag) {
            if(typeof filterTag === 'string') {
               // Tag only
               pool = pool.filter(q => q.tags && q.tags.some(t => t.toLowerCase() === filterTag.toLowerCase()));
            } else if (typeof filterTag === 'object') {
               // Advanced filtering (status)
               const getTier = (id) => (userData.tiers||{})[id] || 1;
               if(filterTag.status === 'new') pool = pool.filter(q => getTier(q.id) === 1);
               if(filterTag.status === 'wip') pool = pool.filter(q => getTier(q.id) > 1 && getTier(q.id) < 4);
               if(filterTag.status === 'mastered') pool = pool.filter(q => getTier(q.id) >= 4);
            }
          }

          const tiers = (id) => (userData.tiers || {})[id] || 1;
          const newQueue = weightedOrder(pool, tiers, "seed-"+Date.now());
          setQueue(newQueue); setQIndex(0); setLoading(false);
       }, [questions, filterTag, userData.tiers]);

       const handleCheck = (selection) => {
          const currentQ = queue[qIndex];
          const correct = JSON.stringify(selection.sort()) === JSON.stringify(currentQ.correct.sort());
          setIsCorrect(correct); setLastSelection(selection); setFeedbackMode(true);
          const newTiers = { ...(userData.tiers || {}) }; const curTier = newTiers[currentQ.id] || 1;
          newTiers[currentQ.id] = correct ? Math.min(5, curTier + 1) : Math.max(1, curTier - 1);
          setUserData(prev => ({ ...prev, tiers: newTiers, score: (prev.score||0) + (correct ? 10 : 0), streak: correct ? (prev.streak||0) + 1 : 0 }));
       };
       const handleNext = () => { setFeedbackMode(false); setLastSelection([]); if(qIndex < queue.length - 1) setQIndex(i => i + 1); else setQueue([]); };

       if(loading) return <div className="min-h-screen flex items-center justify-center text-primary font-bold animate-pulse">Lade Training...</div>;
       if(!queue.length) return <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center space-y-6"><div className="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-3xl flex items-center justify-center"><Icons.Check className="w-12 h-12 text-slate-400"/></div><h2 className="text-xl font-bold dark:text-white">Alles erledigt!</h2><p className="text-slate-500">Für heute gibt es keine Fragen mehr in dieser Kategorie.</p><Button onClick={onExit}>Zurück</Button></div>;

       const currentQ = queue[qIndex];
       const toggleSel = (i) => !feedbackMode && setLastSelection(prev => prev.includes(i) ? prev.filter(x=>x!==i) : [...prev, i]);

       return (
         <div className="h-screen flex flex-col bg-bg-light dark:bg-bg-dark relative overflow-hidden">
            {/* Progress Header */}
            <div className="px-6 pt-12 pb-4 flex items-center gap-4">
               <button onClick={onExit} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><Icons.X className="w-6 h-6"/></button>
               <SegmentedProgress current={qIndex} total={queue.length} />
            </div>

            {/* Question Card */}
            <div className="flex-1 overflow-y-auto px-6 pb-40">
               <div className="max-w-xl mx-auto space-y-8 py-4 animate-slide-up">
                  <div className="space-y-2">
                     <span className="text-xs font-bold uppercase tracking-wider text-primary dark:text-primary-light/80">Level {(userData.tiers||{})[currentQ.id] || 1}</span>
                     <h2 className="text-2xl font-bold text-slate-900 dark:text-white leading-snug">{currentQ.question}</h2>
                  </div>
                  
                  <div className="space-y-3">
                     {currentQ.choices.map((txt, i) => {
                        const sel = lastSelection.includes(i);
                        const isCorr = currentQ.correct.includes(i);
                        let stateStyle = "border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark text-slate-700 dark:text-slate-200";
                        if(feedbackMode) {
                           if(isCorr) stateStyle = "border-success bg-success/10 text-success-dark dark:text-success-light";
                           else if(sel) stateStyle = "border-danger bg-danger/10 text-danger-dark dark:text-danger-light";
                           else stateStyle = "opacity-50 border-transparent";
                        } else if(sel) {
                           stateStyle = "border-primary bg-primary/5 text-primary-dark dark:text-primary-light shadow-[0_0_0_1px_rgba(99,102,241,1)]";
                        }
                        return (
                           <div key={i} onClick={()=>toggleSel(i)} className={`p-4 rounded-2xl border-2 cursor-pointer transition-all duration-200 flex items-start gap-4 ${stateStyle} ${!feedbackMode && 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                              <div className={`w-6 h-6 rounded-lg border-2 flex-shrink-0 flex items-center justify-center transition-colors mt-0.5 ${sel || (feedbackMode && isCorr) ? 'border-current bg-current' : 'border-slate-300 dark:border-slate-600'}`}>
                                 {(sel || (feedbackMode && isCorr)) && <Icons.Check className="w-4 h-4 text-white" strokeWidth={4} />}
                              </div>
                              <span className="font-medium text-base leading-relaxed">{txt}</span>
                           </div>
                        );
                     })}
                  </div>
               </div>
            </div>

            {/* Bottom Actions */}
            <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-bg-light dark:from-bg-dark via-bg-light dark:via-bg-dark to-transparent safe-pb">
               <div className="max-w-xl mx-auto">
                  {!feedbackMode ? (
                     <Button size="lg" fullWidth onClick={()=>handleCheck(lastSelection)} disabled={!lastSelection.length} className="shadow-xl">Bestätigen</Button>
                  ) : (
                     <div className={`p-5 rounded-3xl animate-scale-in border ${isCorrect ? 'bg-success/10 border-success/20' : 'bg-danger/10 border-danger/20'} glass`}>
                        <div className="flex justify-between items-start mb-4">
                           <div>
                              <div className={`text-xl font-black ${isCorrect ? 'text-success' : 'text-danger'}`}>{isCorrect ? 'Stark!' : 'Knapp daneben'}</div>
                              {currentQ.explain && <p className="text-sm mt-1 text-slate-600 dark:text-slate-300 font-medium">{currentQ.explain}</p>}
                              {currentQ.law_ref && <p className="text-xs mt-2 font-mono text-slate-400 bg-white/50 dark:bg-black/20 inline-block px-1.5 py-0.5 rounded">{currentQ.law_ref}</p>}
                           </div>
                        </div>
                        <Button onClick={handleNext} variant={isCorrect ? 'success' : 'danger'} fullWidth>Weiter</Button>
                     </div>
                  )}
               </div>
            </div>
         </div>
       );
    };

    const Dashboard = ({ userData, questions, onStartTrain }) => {
       const tiers = userData.tiers || {};
       const tierValues = Object.values(tiers);
       
       const total = questions.length || 1;
       const mastered = tierValues.filter(t => t >= 4).length;
       const working = tierValues.filter(t => t > 1 && t < 4).length;
       const newItems = Math.max(0, total - mastered - working);
       
       const progress = Math.round((mastered / total) * 100);

       const categories = [
          { name: "BDG", color: "from-orange-400 to-red-500" },
          { name: "SPG", color: "from-blue-400 to-indigo-500" },
          { name: "StPO", color: "from-pink-400 to-rose-500" },
          { name: "StGB", color: "from-purple-500 to-violet-700" },
          { name: "Verkehr", color: "from-amber-400 to-orange-500" },
          { name: "Verfassung", color: "from-cyan-400 to-blue-600" },
          { name: "Verwaltung", color: "from-emerald-400 to-teal-500" }
       ];
       
       return (
         <div className="px-6 py-8 space-y-8 pb-32 animate-fade-in">
            {/* Header */}
            <div className="flex justify-between items-center">
               <h2 className="text-3xl font-black text-slate-800 dark:text-white tracking-tight">Übersicht</h2>
            </div>

            {/* Quick Stats Row */}
            <div className="flex gap-4">
               <div className="flex-1 bg-surface-light dark:bg-surface-dark p-3 rounded-2xl border border-border-light dark:border-border-dark flex items-center gap-3">
                  <div className="p-2 bg-accent/10 rounded-xl text-accent"><Icons.Flame className="w-5 h-5"/></div>
                  <div>
                     <div className="text-xs font-bold text-slate-400 uppercase">Streak</div>
                     <div className="font-black text-slate-800 dark:text-white">{userData.streak} <span className="text-xs font-medium text-slate-400">Tage</span></div>
                  </div>
               </div>
               <div className="flex-1 bg-surface-light dark:bg-surface-dark p-3 rounded-2xl border border-border-light dark:border-border-dark flex items-center gap-3">
                  <div className="p-2 bg-primary/10 rounded-xl text-primary"><Icons.Award className="w-5 h-5"/></div>
                  <div>
                     <div className="text-xs font-bold text-slate-400 uppercase">XP</div>
                     <div className="font-black text-slate-800 dark:text-white">{userData.score}</div>
                  </div>
               </div>
            </div>

            {/* Lernstatus Card */}
            <div className="bg-slate-900 dark:bg-slate-950 p-6 rounded-[2rem] border border-slate-800 shadow-2xl relative overflow-hidden">
               <div className="relative z-10">
                  <h3 className="text-white font-bold text-lg mb-4">Dein Lernstatus</h3>
                  
                  <div className="h-4 bg-slate-800 rounded-full overflow-hidden mb-6 border border-slate-700">
                     <div className="h-full bg-warning transition-all duration-1000 shadow-[0_0_10px_rgba(245,158,11,0.5)]" style={{width: `${Math.max(5, progress)}%`}}></div>
                  </div>

                  <div className="grid grid-cols-3 gap-3">
                     <button onClick={() => onStartTrain({status:'new'})} className="bg-danger/10 border border-danger/20 rounded-xl p-3 text-center transition-transform active:scale-95 hover:bg-danger/20">
                        <div className="text-2xl font-black text-danger">{newItems}</div>
                        <div className="text-[10px] font-bold text-danger/80 uppercase">Neu / Offen</div>
                     </button>
                     <button onClick={() => onStartTrain({status:'wip'})} className="bg-warning/10 border border-warning/20 rounded-xl p-3 text-center transition-transform active:scale-95 hover:bg-warning/20">
                        <div className="text-2xl font-black text-warning">{working}</div>
                        <div className="text-[10px] font-bold text-warning/80 uppercase">In Arbeit</div>
                     </button>
                     <button onClick={() => onStartTrain({status:'mastered'})} className="bg-success/10 border border-success/20 rounded-xl p-3 text-center transition-transform active:scale-95 hover:bg-success/20">
                        <div className="text-2xl font-black text-success">{mastered}</div>
                        <div className="text-[10px] font-bold text-success/80 uppercase">Gemeistert</div>
                     </button>
                  </div>
                  
                  <div className="mt-4 text-center text-xs text-slate-500 font-medium">
                     "Gemeistert" bedeutet: Eine Frage wurde 3x in Folge richtig beantwortet.
                  </div>
               </div>
            </div>

            <Button size="lg" fullWidth onClick={() => onStartTrain(null)} className="shadow-primary/40 py-5 text-lg">JETZT LERNEN</Button>

            {/* Categories */}
            <div className="space-y-4">
               <h3 className="font-bold text-lg text-slate-800 dark:text-white">Kategorien</h3>
               <div className="grid gap-3">
                  {categories.map((cat) => (
                     <button key={cat.name} onClick={() => onStartTrain(cat.name)} className="group bg-surface-light dark:bg-surface-dark p-4 rounded-2xl border border-border-light dark:border-border-dark flex items-center gap-4 transition-all hover:border-primary active:scale-98 text-left">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold text-sm shadow-md bg-gradient-to-br ${cat.color}`}>
                           {cat.name.charAt(0)}
                        </div>
                        <div className="flex-1 font-bold text-slate-700 dark:text-slate-200">{cat.name}</div>
                        <div className="text-primary opacity-0 group-hover:opacity-100 transition-opacity text-xs font-bold uppercase tracking-wider">Starten &rarr;</div>
                     </button>
                  ))}
               </div>
            </div>
         </div>
       );
    };

    /* ================= APP SHELL ================= */
    const App = () => {
       const userManager = useUsers();
       const [activeUser, setActiveUser] = useUserLocalStorage("app", "activeUser", null);
       const [view, setView] = useState("dashboard"); 
       const [darkMode, setDarkMode] = useState(() => localStorage.getItem("theme") !== "light"); // Default Dark
       const [trainFilter, setTrainFilter] = useState(null);
       const { questions, save, remove, status: qStatus } = useQuestions();
       const [userData, setUserData, pStatus] = useUserLocalStorage(activeUser?.id, "progress", { tiers: {}, score: 0, streak: 0 });

       useEffect(() => { if(darkMode) document.documentElement.classList.add("dark"); else document.documentElement.classList.remove("dark"); localStorage.setItem("theme", darkMode ? "dark" : "light"); }, [darkMode]);
       const startTraining = (filter) => { setTrainFilter(filter); setView('train'); };

       if(!activeUser) return <ErrorBoundary><AuthScreen userManager={userManager} onLogin={setActiveUser} /></ErrorBoundary>;
       if(view === 'train') return <ErrorBoundary><TrainingMode questions={questions} userData={userData} setUserData={setUserData} onExit={()=>setView('dashboard')} filterTag={trainFilter} /></ErrorBoundary>;

       const NavItem = ({ id, icon: Icon, label }) => (
         <button onClick={()=>setView(id)} className={`relative p-3 rounded-2xl transition-all duration-300 flex flex-col items-center gap-1 ${view===id ? 'text-primary' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}>
            <Icon className={`w-6 h-6 transition-transform ${view===id ? '-translate-y-1' : ''}`} strokeWidth={view===id ? 2.5 : 2} />
            {view===id && <span className="absolute -bottom-1 w-1 h-1 rounded-full bg-current"></span>}
         </button>
       );

       return (
         <ErrorBoundary>
           <div className="min-h-screen flex flex-col">
             <header className="px-6 pt-12 pb-2 flex justify-between items-center">
                <div className="flex items-center gap-3">
                   <div className="w-10 h-10 rounded-2xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center font-black text-slate-600 dark:text-slate-300 text-lg border-2 border-white dark:border-slate-600 shadow-sm">{activeUser.username.charAt(0)}</div>
                   <div className="flex flex-col">
                      <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hallo</span>
                      <span className="text-sm font-bold dark:text-white">{activeUser.username}</span>
                   </div>
                </div>
                <div className="flex gap-3">
                   <div className="flex items-center justify-center w-10 h-10 bg-surface-light dark:bg-surface-dark rounded-full border border-border-light dark:border-border-dark shadow-sm"><SyncStatus status={pStatus}/></div>
                   <button onClick={()=>setDarkMode(!darkMode)} className="w-10 h-10 flex items-center justify-center bg-surface-light dark:bg-surface-dark rounded-full border border-border-light dark:border-border-dark shadow-sm text-slate-500 hover:text-primary transition-colors">{darkMode ? <Icons.Sun className="w-5 h-5"/> : <Icons.Moon className="w-5 h-5"/>}</button>
                </div>
             </header>

             <main className="flex-1 max-w-lg mx-auto w-full">
                {view === 'dashboard' && <Dashboard userData={userData} questions={questions} onStartTrain={startTraining} />}
                {view === 'admin' && <AdminPanel questions={questions} qManager={{save, remove}} />}
                {view === 'profile' && <ProfileScreen user={activeUser} userManager={userManager} onLogout={()=>setActiveUser(null)} />}
             </main>

             <div className="fixed bottom-6 left-0 w-full flex justify-center z-50 px-4 safe-pb">
                <nav className="glass bg-white/80 dark:bg-slate-900/80 px-6 py-2 rounded-full shadow-2xl border border-white/20 dark:border-slate-700/50 flex items-center gap-8 backdrop-blur-xl">
                   <NavItem id="dashboard" icon={Icons.Home} />
                   <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                   <NavItem id="admin" icon={Icons.Book} />
                   <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                   <NavItem id="profile" icon={Icons.User} />
                </nav>
             </div>
           </div>
         </ErrorBoundary>
       );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
